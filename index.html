<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>VetDesk - Get the Facts Fast</title>

  <!-- React + Babel + Tailwind for development -->
  <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>

  <style>
    body {
      margin: 0;
      font-family: 'Segoe UI', Roboto, sans-serif;
      background-color: #f9fafb;
    }
    .message-bubble { max-width: 75%; margin: 8px 0; position: relative; word-wrap: break-word; }
    .message-bubble.user { margin-left: auto; margin-right: 8px; }
    .message-bubble.bot { margin-left: 8px; margin-right: auto; }
    .message-content { padding: 12px 16px; border-radius: 18px; box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1); position: relative; }
    .message-content.user { background: linear-gradient(135deg, #2563eb 0%, #1d4ed8 100%); color: white; border-bottom-right-radius: 6px; }
    .message-content.bot { background: white; color: #374151; border: 1px solid #e5e7eb; border-bottom-left-radius: 6px; }
    .avatar { width: 28px; height: 28px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 14px; font-weight: 600; flex-shrink: 0; margin: 0 8px; }
    .avatar.user { background: linear-gradient(135deg, #10b981 0%, #059669 100%); color: white; }
    .avatar.bot { background: linear-gradient(135deg, #6366f1 0%, #4f46e5 100%); color: white; }
    .message-row { display: flex; align-items: flex-end; margin: 12px 0; }
    .message-row.user { justify-content: flex-end; }
    .message-row.bot { justify-content: flex-start; }
    .typing-indicator { display: flex; align-items: center; padding: 16px; margin: 12px 8px; }
    .typing-dots { display: flex; gap: 4px; margin-left: 8px; }
    .typing-dot { width: 8px; height: 8px; border-radius: 50%; background-color: #9ca3af; animation: typing 1.4s infinite ease-in-out; }
    .typing-dot:nth-child(1) { animation-delay: -0.32s; }
    .typing-dot:nth-child(2) { animation-delay: -0.16s; }
    .typing-dot:nth-child(3) { animation-delay: 0s; }
    @keyframes typing {
      0%, 80%, 100% { transform: scale(0.8); opacity: 0.5; }
      40% { transform: scale(1); opacity: 1; }
    }
  </style>
</head>
<body>
  <!-- Landing Section -->
  <section class="landing-section text-left py-20 px-6 bg-gradient-to-br from-slate-100 to-slate-200">
    <div class="max-w-4xl mx-auto">
      <div class="text-sm font-bold text-slate-600 tracking-wider uppercase mb-6">VETDESK™</div>
      <h1 class="text-5xl sm:text-6xl font-extrabold tracking-tight text-slate-900 mb-6">
        Get the Facts Fast.
      </h1>
      <p class="text-lg text-slate-700 mb-4 leading-relaxed">
        Every veteran has questions. Few get answers that make sense. VetDesk breaks down policies, benefits, and news in real time—so you see what's happening, what's changing, and what it means for you.
      </p>
      <p class="text-lg text-slate-700 mb-8 leading-relaxed">
        It's not just information. It's context. It's clarity. It's control. Built for veterans who need answers – now.
      </p>
      <button onclick="scrollToChatbot()" class="bg-blue-600 hover:bg-blue-700 text-white font-semibold px-6 py-3 rounded-md shadow-md transition">
        Try Demo – It's Free
      </button>
    </div>
  </section>

  <!-- Chatbot + News Section -->
  <section class="chatbot-section">
    <div class="flex flex-col md:flex-row h-[calc(100vh-160px)]">
      <div class="chat-column flex-1 bg-slate-50 border-r border-slate-200">
        <div id="chatbot-root" class="h-full"></div>
      </div>
      <div class="news-column w-full md:w-[400px] bg-white border-t md:border-t-0 md:border-l border-slate-200">
        <div class="p-4 border-b border-slate-200">
          <h3 class="text-lg font-bold text-slate-800">Recent Veterans News</h3>
        </div>
        <div id="news-container" class="p-4 overflow-y-auto h-full">
          <div class="text-slate-400 text-center">Loading news...</div>
        </div>
      </div>
    </div>
  </section>

  <script>
    function scrollToChatbot() {
      document.querySelector('.chatbot-section').scrollIntoView({ behavior: 'smooth' });
    }
  </script>

  <!-- React App with Streaming Bot Text -->
  <script type="text/babel">
    const { useState, useEffect, useRef } = React;

    const renderMarkdown = (text) => {
      return text
        .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
        .replace(/\*(.*?)\*/g, '<em>$1</em>')
        .replace(/`(.*?)`/g, '<code>$1</code>')
        .replace(/### (.*$)/gm, '<h3>$1</h3>')
        .replace(/## (.*$)/gm, '<h2>$1</h2>')
        .replace(/# (.*$)/gm, '<h1>$1</h1>')
        .replace(/https?:\/\/[^\s<>"]+/g, '<a href="$&" target="_blank" class="text-blue-600 hover:text-blue-800 underline">$&</a>')
        .replace(/\n\n/g, '</p><p>')
        .replace(/\n/g, '<br>')
        .replace(/^/, '<p>')
        .replace(/$/, '</p>')
        .replace(/<p><\/p>/g, '')
        .replace(/\(\[Source\]\((https?:\/\/[^)]+)\)\)/g, '<br><a href="$1" target="_blank" class="text-blue-600 hover:text-blue-800 underline text-sm">Read full article →</a>')
        .replace(/\[Read full article →\]\((https?:\/\/[^)]+)\)/g, '<a href="$1" target="_blank" class="text-blue-600 hover:text-blue-800 underline text-sm">Read full article →</a>');
    };

    function ChatbotApp() {
      const [messages, setMessages] = useState([]);
      const [input, setInput] = useState('');
      const [isLoading, setIsLoading] = useState(false);
      const [lastMessageTime, setLastMessageTime] = useState(0);
      const [streaming, setStreaming] = useState(false);
      const [emailState, setEmailState] = useState({
        waitingForEmail: false,
        lastBotResponse: null,
        lastUserQuestion: null
      });
      const textareaRef = useRef(null);
      const messagesEndRef = useRef(null);

      const MAX_MESSAGE_LENGTH = 2000;

      useEffect(() => {
        const textarea = textareaRef.current;
        if (textarea) {
          textarea.style.height = 'auto';
          textarea.style.height = Math.min(textarea.scrollHeight, 120) + 'px';
        }
      }, [input]);

      useEffect(() => {
        if (messages.length > 1) {
          requestAnimationFrame(() => {
            messagesEndRef.current?.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
          });
        }
      }, [messages]);

      useEffect(() => {
        window.sendMessageFromOutside = (msg) => {
          if (!msg || isLoading || streaming) return;
          setMessages(prev => [...prev, { text: msg, sender: 'user' }]);
          setInput('');
          sendMessageToGemini(msg);
        };
        return () => { delete window.sendMessageFromOutside; };
      }, [isLoading, streaming]);

      const extractTopicFromQuestion = (question) => {
        const lowerQuestion = question.toLowerCase();
        if (lowerQuestion.includes('claim')) return 'VA Claims Process';
        if (lowerQuestion.includes('appeal')) return 'VA Appeals Process';
        if (lowerQuestion.includes('disability')) return 'Disability Benefits';
        return 'VA Benefits Information';
      };

      const shouldOfferEmail = (botResponse) => {
        return botResponse.length > 200 && (
          botResponse.includes('step') ||
          botResponse.includes('process') ||
          botResponse.includes('claim')
        );
      };

      // Main streaming effect!
      const streamBotText = (botText, originalQuestion) => {
        setStreaming(true);
        setMessages(prev => [...prev, { text: '', sender: 'model' }]);
        let index = 0;
        const interval = setInterval(() => {
          index++;
          setMessages(prev => {
            const newMessages = [...prev];
            newMessages[newMessages.length - 1] = { text: botText.slice(0, index), sender: 'model' };
            return newMessages;
          });
          if (index >= botText.length) {
            clearInterval(interval);
            // After message is fully streamed, check for email
            if (shouldOfferEmail(botText) && !emailState.waitingForEmail) {
              setMessages(prev => [...prev, { text: "\n\nWould you like me to send this to your email for future reference?", sender: 'model' }]);
              setEmailState({
                waitingForEmail: true,
                lastBotResponse: botText,
                lastUserQuestion: originalQuestion
              });
            }
            setStreaming(false);
            setIsLoading(false);
          }
        }, 16); // 16ms ~ 60 chars/sec (adjust for faster/slower effect)
      };

      const sendMessageToGemini = async (userMessage, articleContext = "") => {
        const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
        if (emailState.waitingForEmail && emailRegex.test(userMessage.trim())) {
          setIsLoading(true);
          try {
            const response = await fetch('https://vetdesk-demo2-api.vercel.app/api/send-summary', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({
                email: userMessage.trim(),
                subject: extractTopicFromQuestion(emailState.lastUserQuestion),
                content: emailState.lastBotResponse,
                userName: 'Veteran'
              })
            });
            const result = await response.json();
            if (result.success) {
              setMessages(prev => [...prev, { text: `✅ ${result.message}`, sender: 'model' }]);
            } else {
              setMessages(prev => [...prev, { text: "Sorry, couldn't send email. Please try again.", sender: 'model' }]);
            }
          } catch (error) {
            setMessages(prev => [...prev, { text: "Sorry, couldn't send email. Please try again.", sender: 'model' }]);
          }
          setEmailState({ waitingForEmail: false, lastBotResponse: null, lastUserQuestion: null });
          setIsLoading(false);
          return;
        }

        const now = Date.now();
        const timeSinceLastMessage = now - lastMessageTime;
        if (timeSinceLastMessage < 5000) return;
        setLastMessageTime(now);
        setIsLoading(true);

        try {
          let faqJson = {};
          try {
            const faqContextRes = await fetch("https://jsonblob.com/api/jsonBlob/1393450047760424960");
            faqJson = await faqContextRes.json();
          } catch (faqError) {
            // skip
          }

          let newsContext = "";
          if (userMessage.toLowerCase().includes("news") || userMessage.toLowerCase().includes("recent va")) {
            try {
              const newsRes = await fetch("https://vetdesk-demo2-api.vercel.app/api/va-news");
              if (newsRes.ok) {
                const newsData = await newsRes.json();
                newsContext = newsData.summary || "";
              }
            } catch {}
          }

          if (!faqJson.system_resources) faqJson.system_resources = {};

          const systemPrompt = `You are a knowledgeable VA benefits specialist who communicates like a helpful, candid, and empathetic friend. Your job is to translate complex VA news and policy into plain English, giving veterans a realistic and compassionate understanding of how changes may impact them. Answers should be on a 10th grade level.

When asked about news or policy changes:
Always acknowledge the user's concerns or feelings before providing information.
Thank veterans sincerely when they identify themselves, and express appreciation for their service.
Analyze both the positive and negative potential impacts for veterans, referencing real-world outcomes or VA history when relevant—even if the news is not reassuring.
If there are risks (such as delays, backlogs, or reduced access), explain them clearly and empathetically.
Identify which groups of veterans are most likely to be affected e.g., rural, disabled, those with complex claims.
Offer actionable, practical advice, such as monitoring claims, keeping documentation, or contacting the VA if delays occur.
Do not simply repeat official statements; provide a frank, evidence-based critique and question optimistic claims when appropriate, while maintaining a courteous and supportive tone.
Use warm, supportive, and patient language. Avoid abrupt or dismissive transitions like "Now," or "Anyway". After thanking a veteran, use gentle invitations such as "How can I assist you further with..." or "Please let me know if you have more questions about...".
Keep answers conversational but informative (2–4 sentences). Use **bold** for important numbers or deadlines.
End responses naturally. Don't always ask 'What else can I help you with?' For follow-up questions, just end normally or ask 'Make sense?' For news articles, you can ask 'Want me to check another article?' Keep it conversational, not robotic.

Your responses should always be attentive, respectful, and honest—even if the truth is uncomfortable. Veterans rely on you for clarity, empathy, and actionable support—not just reassurance. Don't say 'thank you for your service' unless someone specifically mentions they're a veteran. Focus on answering their question.`;

          let chatHistoryForAPI = [
            {
              role: "user",
              parts: [{ text: systemPrompt + (newsContext ? " Current VA News: " + newsContext : "") + (articleContext ? " Article Context: " + articleContext : "") }]
            },
            {
              role: "user",
              parts: [{ text: JSON.stringify(faqJson) }]
            }
          ];

          messages.forEach(msg => {
            chatHistoryForAPI.push({
              role: msg.sender === 'user' ? 'user' : 'model',
              parts: [{ text: msg.text }]
            });
          });

          chatHistoryForAPI.push({
            role: "user",
            parts: [{ text: userMessage }]
          });

          const response = await fetch("https://vetdesk-demo2-api.vercel.app/api/chat", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ chatHistory: chatHistoryForAPI })
          });

          const result = await response.json();
          const botText = result?.candidates?.[0]?.content?.parts?.[0]?.text || "Sorry, I couldn't get a response.";

          streamBotText(botText, userMessage);
        } catch (e) {
          setMessages(prev => [...prev, {
            text: "I'm experiencing technical difficulties. Try later or call VA at 1-800-827-1000.",
            sender: 'model'
          }]);
          setStreaming(false);
          setIsLoading(false);
        }
      };

      const handleSend = () => {
        if (!input.trim() || isLoading || streaming) return;

        if (input.toLowerCase().includes('yes') && emailState.lastBotResponse) {
          setEmailState(prev => ({ ...prev, waitingForEmail: true }));
          setMessages(prev => [...prev, 
            { text: input, sender: 'user' },
            { text: "What's your email address?", sender: 'model' }
          ]);
          setInput('');
          return;
        }

        if (input.toLowerCase().includes('no') && emailState.lastBotResponse) {
          setEmailState({ waitingForEmail: false, lastBotResponse: null, lastUserQuestion: null });
          setMessages(prev => [...prev, 
            { text: input, sender: 'user' },
            { text: "No problem! What else can I help you with?", sender: 'model' }
          ]);
          setInput('');
          return;
        }

        setMessages(prev => [...prev, { text: input, sender: 'user' }]);
        setInput('');
        sendMessageToGemini(input);
      };

      const handleKeyPress = (e) => {
        if (e.key === 'Enter' && !e.shiftKey) {
          e.preventDefault();
          handleSend();
        }
      };

      const handleInputChange = (e) => {
        const newValue = e.target.value;
        if (newValue.length <= MAX_MESSAGE_LENGTH) {
          setInput(newValue);
        }
      };

      const quickActions = [
        {
          text: "How does the VA calculate disability ratings, and what counts as service-connected? How does the combined rating formula work?",
          label: "Disability Ratings"
        },
        {
          text: "What are my options for appealing a VA decision? What are the different appeal lanes and their deadlines?",
          label: "Appeals Process"
        },
        {
          text: "How do VA healthcare priority groups work, and how do I access care? When can I use non-VA providers?",
          label: "Healthcare Enrollment"
        },
        {
          text: "What are the eligibility requirements for VA benefits, and how do I know which programs or family benefits I qualify for?",
          label: "Eligibility"
        },
        {
          text: "Which forms do I need to file for my situation, and how do I use VA.gov or My HealtheVet to track my claim or upload documents?",
          label: "Forms & Online Tools"
        }
      ];

      const renderMessage = (msg, index) => {
        const isUser = msg.sender === 'user';
        return (
          <div key={index} className={`message-row ${isUser ? 'user' : 'bot'}`}>
            {!isUser && <div className="avatar bot">VD</div>}
            <div className={`message-bubble ${isUser ? 'user' : 'bot'}`}>
              <div className={`message-content ${isUser ? 'user' : 'bot'}`}>
                <div dangerouslySetInnerHTML={{ __html: renderMarkdown(msg.text) }} />
              </div>
            </div>
            {isUser && <div className="avatar user">U</div>}
          </div>
        );
      };

      return (
        <div className="flex flex-col h-full">
          <div className="flex-1 overflow-y-auto p-4 space-y-4">
            {messages.length === 0 && !isLoading && !streaming ? (
              <div className="flex flex-col items-center justify-center h-full text-center p-6">
                <div className="mb-6">
                  <h2 className="text-2xl font-bold text-gray-800 mb-3">Welcome to VetDesk</h2>
                  <p className="text-lg text-gray-600 leading-relaxed mb-4">Get answers about your benefits or how current events will affect them.</p>
                  <p className="text-sm text-gray-500 mb-4 italic">Note: For your privacy, we don't store conversations. Refreshing or leaving this page will reset your session.</p>
                </div>
                <div className="flex flex-wrap justify-center gap-2">
                  {quickActions.map((action, idx) => (
                    <button
                      key={idx}
                      onClick={() => {
                        if (isLoading || streaming) return;
                        setMessages(prev => [...prev, { text: action.text, sender: 'user' }]);
                        setTimeout(() => sendMessageToGemini(action.text), 100);
                      }}
                      disabled={isLoading || streaming}
                      className="px-3 py-2 rounded-lg text-sm transition-colors bg-blue-100 text-blue-700 hover:bg-blue-200 disabled:opacity-50"
                    >
                      {action.label}
                    </button>
                  ))}
                </div>
              </div>
            ) : (
              messages.map(renderMessage)
            )}
            {(isLoading || streaming) && (
              <div className="typing-indicator">
                <div className="avatar bot">VD</div>
                <div className="typing-dots">
                  <div className="typing-dot"></div>
                  <div className="typing-dot"></div>
                  <div className="typing-dot"></div>
                </div>
              </div>
            )}
            <div ref={messagesEndRef}></div>
          </div>
          <div className="border-t p-4 bg-white flex gap-2">
            <textarea
              ref={textareaRef}
              className="flex-1 p-2 border border-gray-300 rounded-md resize-none"
              rows="2"
              value={input}
              onChange={handleInputChange}
              onKeyDown={handleKeyPress}
              placeholder="Ask a question about your VA benefits..."
              disabled={isLoading || streaming}
            />
            <button
              onClick={handleSend}
              disabled={!input.trim() || isLoading || streaming}
              className="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-md font-semibold"
            >
              Send
            </button>
          </div>
        </div>
      );
    }

    function NewsApp() {
      const [newsArticles, setNewsArticles] = useState([]);
      const [isLoading, setIsLoading] = useState(true);

      useEffect(() => {
        fetch('https://vetdesk-demo2-api.vercel.app/api/va-news')
          .then(res => res.json())
          .then(data => {
            setNewsArticles(data.sources || []);
            setIsLoading(false);
          })
          .catch(() => { setIsLoading(false); });
      }, []);

      const handleNewsQuestion = (article) => {
        const question = `How does this news affect my benefits: "${article.title}"`;
        if (typeof window.sendMessageFromOutside === "function") {
          window.sendMessageFromOutside(question);
        }
        const chatbox = document.querySelector('#chatbot-root');
        if (chatbox) {
          chatbox.scrollIntoView({ behavior: 'smooth' });
        }
      };

      if (isLoading) return <div className="text-center text-slate-400">Loading news...</div>;
      if (!newsArticles.length) return <div className="text-center text-slate-400">No news available</div>;

      return (
        <div className="space-y-4">
          {newsArticles.map((article, index) => (
            <div key={index} className="news-article border rounded-lg bg-gray-50 overflow-hidden">
              {article.image && (
                <img src={article.image} alt={article.title} className="w-full h-40 object-cover" />
              )}
              <div className="p-4">
                <h4 className="font-semibold text-slate-900 mb-1">{article.title}</h4>
                <span className="text-sm text-slate-500">{new Date(article.pubDate).toLocaleDateString()} – {article.source}</span>
                <button
                  onClick={() => handleNewsQuestion(article)}
                  className="mt-3 w-full bg-blue-600 hover:bg-blue-700 text-white text-sm font-medium py-2 rounded-md"
                >
                  How does this affect me?
                </button>
              </div>
            </div>
          ))}
        </div>
      );
    }

    const chatRoot = document.getElementById('chatbot-root');
    if (chatRoot) {
      try {
        ReactDOM.createRoot(chatRoot).render(<ChatbotApp />);
      } catch (error) {
        console.error('Failed to render chatbot:', error);
        chatRoot.innerHTML = '<div class="text-center text-red-500 p-4">Chatbot temporarily unavailable.</div>';
      }
    }
    const newsRoot = document.getElementById('news-container');
    if (newsRoot) {
      try {
        ReactDOM.createRoot(newsRoot).render(<NewsApp />);
      } catch (error) {
        console.error('Failed to render news:', error);
        newsRoot.innerHTML = '<div class="text-center text-red-500 p-4">News temporarily unavailable.</div>';
      }
    }
  </script>
</body>
</html>
