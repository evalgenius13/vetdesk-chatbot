<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>VetDesk AI</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="icon" type="image/png" href="favicon.png">

  <style>
    html, body, #root {
      height: 100%;
      margin: 0;
      background: #f9fafb;
      font-family: 'Segoe UI', sans-serif;
    }
    .message-bubble {
      max-width: 75%;
      margin: 8px 0;
      position: relative;
      word-wrap: break-word;
    }
    .message-bubble.user { margin-left: auto; margin-right: 8px; }
    .message-bubble.bot { margin-left: 8px; margin-right: auto; }
    .message-content {
      padding: 12px 16px;
      border-radius: 18px;
      box-shadow: 0 1px 3px rgba(0, 0, 0, 0.07);
      position: relative;
    }
    .message-content.user {
      background: linear-gradient(135deg, #2563eb 0%, #1d4ed8 100%);
      color: white;
      border-bottom-right-radius: 6px;
    }
    .message-content.bot {
      background: white;
      color: #374151;
      border: 1px solid #e5e7eb;
      border-bottom-left-radius: 6px;
    }
    .avatar {
      width: 28px;
      height: 28px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 14px;
      font-weight: 600;
      flex-shrink: 0;
      margin: 0 8px;
    }
    .avatar.user {
      background: linear-gradient(135deg, #10b981 0%, #059669 100%);
      color: white;
    }
    .avatar.bot {
      background: linear-gradient(135deg, #6366f1 0%, #4f46e5 100%);
      color: white;
    }
    .message-row {
      display: flex;
      align-items: flex-end;
      margin: 12px 0;
    }
    .message-row.user { justify-content: flex-end; }
    .message-row.bot { justify-content: flex-start; }
    .typing-indicator {
      display: flex;
      align-items: center;
      padding: 16px;
      margin: 12px 8px;
    }
    .typing-dots {
      display: flex;
      gap: 4px;
      margin-left: 8px;
    }
    .typing-dot {
      width: 8px;
      height: 8px;
      border-radius: 50%;
      background-color: #9ca3af;
      animation: typing 1.4s infinite ease-in-out;
    }
    .typing-dot:nth-child(1) { animation-delay: -0.32s; }
    .typing-dot:nth-child(2) { animation-delay: -0.16s; }
    .typing-dot:nth-child(3) { animation-delay: 0s; }
    @keyframes typing {
      0%, 80%, 100% { transform: scale(0.8); opacity: 0.5; }
      40% { transform: scale(1); opacity: 1; }
    }
  </style>
</head>
<body>
  <div id="root"></div>
  <script type="text/babel">
// Render Markdown
function renderMarkdown(text) {
  return text
    .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
    .replace(/\*(.*?)\*/g, '<em>$1</em>')
    .replace(/`(.*?)`/g, '<code>$1</code>')
    .replace(/### (.*$)/gm, '<h3>$1</h3>')
    .replace(/## (.*$)/gm, '<h2>$1</h2>')
    .replace(/# (.*$)/gm, '<h1>$1</h1>')
    .replace(/https?:\/\/[^\s<>"]+/g, '<a href="$&" target="_blank" class="text-blue-600 hover:underline">$&</a>')
    .replace(/\n\n/g, '</p><p>')
    .replace(/\n/g, '<br>')
    .replace(/^/, '<p>').replace(/$/, '</p>').replace(/<p><\/p>/g, '');
}

// Landing Page
function Landing({ onTryNow }) {
  return (
    <section className="flex flex-col justify-center h-screen px-6 bg-gradient-to-br from-slate-100 to-slate-200">
      <div className="max-w-4xl mx-auto">
        <div className="text-sm font-bold text-slate-600 uppercase mb-6">VETDESKâ„¢</div>
        <h1 className="text-5xl font-extrabold text-slate-900 mb-6">Get the Facts Fast.</h1>
        <p className="text-lg text-slate-700 mb-4">VetDesk breaks down VA policies, benefits, and news in real time â€” giving you answers that make sense.</p>
        <p className="text-lg text-slate-700 mb-8">Itâ€™s not just information. Itâ€™s clarity. Itâ€™s control. Built for veterans who need answers â€” now.</p>
        <button onClick={onTryNow}
          className="bg-blue-600 hover:bg-blue-700 text-white font-semibold px-6 py-3 rounded-md shadow-md transition">
          Try Now
        </button>
      </div>
    </section>
  );
}

// News Panel
function NewsPanel({ onAsk }) {
  const [articles, setArticles] = React.useState([]);
  const [loading, setLoading] = React.useState(true);

  React.useEffect(() => {
    fetch("https://vetdesk-demo2-api.vercel.app/api/va-news")
      .then(res => res.json())
      .then(data => {
        setArticles(data.sources || []);
        setLoading(false);
      })
      .catch(() => setLoading(false));
  }, []);

  return (
    <aside className="w-full md:w-[400px] border-r border-slate-200 bg-white h-full overflow-y-auto p-4">
      <h2 className="text-xl font-bold mb-4 text-slate-800">Veterans News</h2>
      {loading ? (
        <p className="text-slate-400 text-sm">Loading newsâ€¦</p>
      ) : articles.length ? (
        articles.map((article, idx) => (
          <div key={idx} className="mb-6 pb-4 border-b last:border-none">
            {article.image && (
              <img src={article.image} alt={article.title} className="mb-2 w-full h-36 object-cover rounded" />
            )}
            <h3 className="text-base font-semibold text-slate-900 mb-1">{article.title}</h3>
            <p className="text-xs text-slate-500">{new Date(article.pubDate).toLocaleDateString()} â€¢ {article.source}</p>
            <button
              onClick={() => onAsk(`How does this news affect my benefits: "${article.title}"`)}
              className="mt-3 w-full bg-blue-600 hover:bg-blue-700 text-white text-sm font-semibold py-2 rounded-md transition"
            >
              How does this affect me?
            </button>
          </div>
        ))
      ) : (
        <p className="text-slate-400 text-sm">No articles found.</p>
      )}
    </aside>
  );
}

// Chatbot Panel with collapsible quick actions
function ChatbotPanel({ messages, input, setInput, onSend, streaming, isLoading, emailState, onQuickAsk }) {
  const textareaRef = React.useRef(null);
  const messagesEndRef = React.useRef(null);
  const [showQuickActions, setShowQuickActions] = React.useState(true);

  const quickActions = [
    { text: "How does the VA calculate disability ratings, and what counts as service-connected? How does the combined rating formula work?", label: "Disability Ratings" },
    { text: "What are my options for appealing a VA decision? What are the different appeal lanes and their deadlines?", label: "Appeals Process" },
    { text: "How do VA healthcare priority groups work, and how do I access care? When can I use non-VA providers?", label: "Healthcare Enrollment" },
    { text: "What are the eligibility requirements for VA benefits, and how do I know which programs or family benefits I qualify for?", label: "Eligibility" },
    { text: "Which forms do I need to file for my situation, and how do I use VA.gov or My HealtheVet to track my claim or upload documents?", label: "Forms & Online Tools" }
  ];

  // âœ… Declare chatStarted before it's used
  const chatStarted = messages.length > 0 || input.trim() !== "" || isLoading || streaming;

  // Auto-scroll to latest message
  React.useEffect(() => {
    if (messagesEndRef.current) messagesEndRef.current.scrollIntoView({ behavior: "smooth" });
  }, [messages, streaming]);

  return (
    <main className="flex flex-col flex-1 h-full">
      {/* ðŸ”¹ Quick Actions â€” always visible, collapsible manually */}
      <div className="border-b border-slate-200 bg-white px-4 pt-3 pb-2">
        <div className="flex flex-wrap justify-center items-center gap-2 relative">
          {showQuickActions && quickActions.map((action, idx) => (
            <button
              key={idx}
              onClick={() => onQuickAsk(action.text)}
              disabled={isLoading || streaming}
              className="px-3 py-2 rounded-md text-sm bg-blue-100 text-blue-700 hover:bg-blue-200 disabled:opacity-50 font-medium transition"
            >
              {action.label}
            </button>
          ))}

          {/* Toggle Icon Button */}
          <button
            onClick={() => setShowQuickActions(!showQuickActions)}
            aria-label={showQuickActions ? "Hide Quick Actions" : "Show Quick Actions"}
            className="ml-2 p-1 text-blue-600 hover:text-blue-800 focus:outline-none"
          >
            {showQuickActions ? (
              <svg width="18" height="18" viewBox="0 0 20 20" fill="none">
                <path d="M6 12l4-4 4 4" stroke="currentColor" strokeWidth="2" strokeLinecap="round" />
              </svg>
            ) : (
              <svg width="18" height="18" viewBox="0 0 20 20" fill="none">
                <path d="M6 8l4 4 4-4" stroke="currentColor" strokeWidth="2" strokeLinecap="round" />
              </svg>
            )}
          </button>
        </div>
      </div>

      {/* ðŸ”¹ Welcome Message â€” Only shown before chat starts */}
      {!chatStarted && !emailState?.waitingForEmail && (
        <div className="flex flex-1 flex-col justify-center items-center text-center px-6">
          <h2 className="text-2xl font-bold text-gray-800 mb-3">Welcome to VetDesk</h2>
          <p className="text-lg text-gray-600 mb-2">
            Get clear, plain-English answers about your VA benefits and what's changing.
          </p>
          <p className="text-sm text-gray-500 italic">
            This conversation isnâ€™t saved. Donâ€™t refresh or close the page unless you're done. (Update this message.)
          </p>
        </div>
      )}

      {/* ðŸ”¹ Chat Messages */}
      <div className="flex-1 px-4 py-2 space-y-2 overflow-y-auto">
        {messages.map((msg, idx) => (
          <div key={idx} className={`message-row ${msg.sender}`}>
            {msg.sender === "bot" && <div className="avatar bot">VD</div>}
            <div className={`message-bubble ${msg.sender}`}>
              <div className={`message-content ${msg.sender}`} dangerouslySetInnerHTML={{ __html: renderMarkdown(msg.text) }} />
            </div>
            {msg.sender === "user" && <div className="avatar user">U</div>}
          </div>
        ))}

        {(isLoading || streaming) && (
          <div className="typing-indicator">
            <div className="avatar bot">VD</div>
            <div className="typing-dots">
              <div className="typing-dot"></div>
              <div className="typing-dot"></div>
              <div className="typing-dot"></div>
            </div>
          </div>
        )}
        <div ref={messagesEndRef}></div>
      </div>

      {/* ðŸ”¹ Email Prompt */}
      {emailState?.waitingForEmail && (
        <div className="p-4 bg-yellow-50 text-yellow-800 text-sm border-t border-b border-yellow-200 flex flex-col gap-2">
          <span>Want this answer emailed? Enter your email and press Send.</span>
        </div>
      )}

      {/* ðŸ”¹ Input Area */}
      <div className="border-t p-4 bg-white flex gap-2">
        <textarea
          ref={textareaRef}
          value={input}
          onChange={(e) => setInput(e.target.value)}
          rows="2"
          className="flex-1 p-2 border border-gray-300 rounded-md resize-none"
          placeholder={
            emailState.waitingForEmail
              ? "Enter your email addressâ€¦"
              : "Ask a question about your VA benefitsâ€¦"
          }
          onKeyDown={(e) => {
            if (e.key === "Enter" && !e.shiftKey) {
              e.preventDefault();
              onSend();
            }
          }}
          disabled={isLoading || streaming}
        />
        <button
          onClick={onSend}
          disabled={!input.trim() || isLoading || streaming}
          className="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-md font-semibold"
        >
          Send
        </button>
      </div>
    </main>
  );
}
function App() {
  const [started, setStarted] = React.useState(false);
  const [messages, setMessages] = React.useState([]);
  const [input, setInput] = React.useState("");
  const [isLoading, setIsLoading] = React.useState(false);
  const [streaming, setStreaming] = React.useState(false);
  const [lastMessageTime, setLastMessageTime] = React.useState(0);

  const [emailState, setEmailState] = React.useState({
    waitingForEmail: false,
    lastBotResponse: null,
    lastUserQuestion: null
  });

  // Email subject helper
  function extractTopicFromQuestion(question) {
    const q = question.toLowerCase();
    if (q.includes("claim")) return "VA Claims Process";
    if (q.includes("appeal")) return "VA Appeals Process";
    if (q.includes("disability")) return "Disability Benefits";
    return "VA Benefits Information";
  }

  function shouldOfferEmail(botText) {
    return botText.length > 250 &&
      (botText.includes("step") || botText.includes("process") || botText.includes("deadline"));
  }

  function streamBotText(botText, originalQuestion) {
    setStreaming(true);
    setMessages(prev => [...prev, { text: "", sender: "bot" }]);
    let index = 0;
    const interval = setInterval(() => {
      index++;
      setMessages(prev => {
        const updated = [...prev];
        updated[updated.length - 1] = { text: botText.slice(0, index), sender: "bot" };
        return updated;
      });
      if (index >= botText.length) {
        clearInterval(interval);
        // offer email if needed
        if (shouldOfferEmail(botText)) {
          setMessages(prev => [...prev, { text: "Would you like me to send this to your email for future reference?", sender: "bot" }]);
          setEmailState({
            waitingForEmail: false,
            lastBotResponse: botText,
            lastUserQuestion: originalQuestion
          });
        }
        setStreaming(false);
        setIsLoading(false);
      }
    }, 15);
  }

  async function sendMessageToGemini(userMessage, articleContext = "") {
    const now = Date.now();
    if (now - lastMessageTime < 2000) return;
    setLastMessageTime(now);

    // Handle email case
    const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
    if (emailState.waitingForEmail && emailRegex.test(userMessage)) {
      setIsLoading(true);
      try {
        const res = await fetch('https://vetdesk-demo2-api.vercel.app/api/send-summary', {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({
            email: userMessage,
            subject: extractTopicFromQuestion(emailState.lastUserQuestion),
            content: emailState.lastBotResponse,
            userName: "Veteran"
          })
        });
        const result = await res.json();
        if (result?.success) {
          setMessages(prev => [...prev, { text: "âœ… Summary sent to your email.", sender: "bot" }]);
        } else {
          throw new Error();
        }
      } catch {
        setMessages(prev => [...prev, { text: "Unable to send email right now. Please try again.", sender: "bot" }]);
      }
      setEmailState({ waitingForEmail: false, lastBotResponse: null, lastUserQuestion: null });
      setIsLoading(false);
      return;
    }

    // Handle normal message flow
    setIsLoading(true);
    try {
      let newsContext = "";
      if (userMessage.toLowerCase().includes("news")) {
        const news = await fetch("https://vetdesk-demo2-api.vercel.app/api/va-news").then(r => r.json());
        newsContext = news?.summary || "";
      }

      const faqData = await fetch("https://jsonblob.com/api/jsonBlob/1393450047760424960")
        .then(res => res.json())
        .catch(() => ({}));

      const systemPrompt = `You are a helpful expert in VA benefits...`; // (shortened for brevity)

      const chatHistoryForAPI = [
        { role: "user", parts: [{ text: systemPrompt + (newsContext ? "\n\nNews Context: " + newsContext : "") + (articleContext ? "\n\nArticle Context: " + articleContext : "") }] },
        { role: "user", parts: [{ text: JSON.stringify(faqData) }] },
        ...messages.map(m => ({
          role: m.sender === "user" ? "user" : "model",
          parts: [{ text: m.text }]
        })),
        { role: "user", parts: [{ text: userMessage }] }
      ];

      const response = await fetch("https://vetdesk-demo2-api.vercel.app/api/chat", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ chatHistory: chatHistoryForAPI })
      });

      const json = await response.json();
      const botText = json?.candidates?.[0]?.content?.parts?.[0]?.text;
      streamBotText(botText || "Sorry, I couldn't get a response.", userMessage);
    } catch (err) {
      setMessages(prev => [...prev, {
        text: "I'm experiencing technical difficulties. Try again later or call VA at 1-800-827-1000.",
        sender: "bot"
      }]);
      setIsLoading(false);
      setStreaming(false);
    }
  }

  function onSend() {
    if (!input.trim() || isLoading || streaming) return;

    const lower = input.toLowerCase();
    if (lower === "yes" && emailState.lastBotResponse) {
      setEmailState(prev => ({ ...prev, waitingForEmail: true }));
      setMessages(prev => [...prev, { text: input, sender: "user" }, { text: "What's your email address?", sender: "bot" }]);
      setInput("");
      return;
    }
    if (lower === "no" && emailState.lastBotResponse) {
      setEmailState({ waitingForEmail: false, lastBotResponse: null, lastUserQuestion: null });
      setMessages(prev => [...prev, { text: input, sender: "user" }, { text: "Okay, what else can I help with?", sender: "bot" }]);
      setInput("");
      return;
    }

    setMessages(prev => [...prev, { text: input, sender: "user" }]);
    sendMessageToGemini(input);
    setInput("");
  }

  function onQuickAsk(text) {
    setMessages(prev => [...prev, { text, sender: "user" }]);
    sendMessageToGemini(text);
  }

  function handleNewsAsk(text) {
    onQuickAsk(text);
  }

  return started ? (
    <div className="flex h-screen">
      <NewsPanel onAsk={handleNewsAsk} />
      <ChatbotPanel
        messages={messages}
        onSend={onSend}
        input={input}
        setInput={setInput}
        streaming={streaming}
        isLoading={isLoading}
        emailState={emailState}
        onQuickAsk={onQuickAsk}
      />
    </div>
  ) : (
    <Landing onTryNow={() => setStarted(true)} />
  );
}

// Mount app
ReactDOM.createRoot(document.getElementById("root")).render(
  <React.StrictMode>
    <App />
  </React.StrictMode>
);
</script>
</body>
</html>
