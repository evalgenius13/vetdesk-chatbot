<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>VetDesk‚Ñ¢</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
  <link rel="icon" type="image/png" href="/favicon.png">
  <style>
    html, body, #root {
      height: 100%;
      margin: 0;
      background: #f9fafb;
      font-family: 'Segoe UI', sans-serif;
    }
    .message-bubble { 
      max-width: 75%; 
      margin: 8px 0; 
      position: relative; 
      word-wrap: break-word; 
    }
    .message-bubble.user { 
      margin-left: auto; 
      margin-right: 8px; 
    }
    .message-bubble.bot { 
      margin-left: 8px; 
      margin-right: auto; 
    }
    .message-content { 
      padding: 12px 16px; 
      border-radius: 18px; 
      box-shadow: 0 1px 3px rgba(0,0,0,0.07); 
      position: relative; 
    }
    .message-content.user { 
      background: linear-gradient(135deg, #1e3a8a 0%, #1e40af 100%); 
      color: white; 
      border-bottom-right-radius: 6px; 
    }
    .message-content.bot { 
      background: white; 
      color: #374151; 
      border: 1px solid #e5e7eb; 
      border-bottom-left-radius: 6px; 
    }
    .avatar { 
      width: 28px; 
      height: 28px; 
      border-radius: 50%; 
      display: flex; 
      align-items: center; 
      justify-content: center; 
      font-size: 14px; 
      font-weight: 600; 
      flex-shrink: 0; 
      margin: 0 8px; 
    }
    .avatar.user { 
      background: linear-gradient(135deg, #10b981 0%, #059669 100%); 
      color: white; 
    }
    .avatar.bot { 
      background: linear-gradient(135deg, #1e3a8a 0%, #1e40af 100%); 
      color: white; 
    }
    .message-row { 
      display: flex; 
      align-items: flex-end; 
      margin: 12px 0; 
    }
    .message-row.user { 
      justify-content: flex-end; 
    }
    .message-row.bot { 
      justify-content: flex-start; 
    }
    .typing-indicator { 
      display: flex; 
      align-items: center; 
      padding: 16px; 
      margin: 12px 8px; 
    }
    .typing-dots { 
      display: flex; 
      gap: 4px; 
      margin-left: 8px; 
    }
    .typing-dot { 
      width: 8px; 
      height: 8px; 
      border-radius: 50%; 
      background-color: #9ca3af; 
      animation: typing 1.4s infinite ease-in-out; 
    }
    .typing-dot:nth-child(1) { 
      animation-delay: -0.32s; 
    }
    .typing-dot:nth-child(2) { 
      animation-delay: -0.16s; 
    }
    .typing-dot:nth-child(3) { 
      animation-delay: 0s; 
    }
    @keyframes typing { 
      0%, 80%, 100% { 
        transform: scale(0.8); 
        opacity: 0.5; 
      } 
      40% { 
        transform: scale(1); 
        opacity: 1; 
      } 
    }
    @media (max-width: 768px) {
      .message-bubble { 
        max-width: 90%; 
      }
      .news-panel { 
        position: fixed; 
        top: 0; 
        left: 0; 
        height: 100vh; 
        width: 300px; 
        z-index: 30; 
        transform: translateX(-100%); 
        transition: transform 0.3s ease; 
        box-shadow: 2px 0 5px rgba(0,0,0,0.1);
      }
      .news-panel.open { 
        transform: translateX(0);
      }
      .news-overlay { 
        position: fixed; 
        top: 0; 
        left: 0; 
        width: 100vw; 
        height: 100vh; 
        background: rgba(0,0,0,0.3); 
        z-index: 20; 
        opacity: 0; 
        visibility: hidden; 
        transition: opacity 0.3s ease, visibility 0.3s ease;
      }
      .news-overlay.open { 
        opacity: 1; 
        visibility: visible;
      }
      .mobile-news-toggle { 
        position: fixed; 
        top: 20px; 
        left: 20px; 
        z-index: 40; 
        background: white; 
        border: 1px solid #e5e7eb; 
        border-radius: 50%; 
        width: 44px; 
        height: 44px; 
        display: flex; 
        align-items: center; 
        justify-content: center; 
        box-shadow: 0 2px 8px rgba(0,0,0,0.1);
      }      
      .quick-actions { 
        flex-direction: column; 
        gap: 8px;
      }
      .quick-actions button { 
        width: 100%; 
      }
    }
    @media (min-width: 769px) {
      .mobile-news-toggle { 
        display: none; 
      }
      .news-overlay { 
        display: none; 
      }
    }
    .text-normal { 
      font-size: 1rem; 
    }
    .text-large { 
      font-size: 1.125rem; 
    }
    .text-large .message-content { 
      font-size: 1.125rem; 
    }
    .text-large .quick-actions button { 
      font-size: 1rem; 
    }
  </style>
</head>
<body>
  <div id="root"></div>
  <script type="text/babel">
  const systemPrompt = `You are a helpful VA benefits expert who explains things in plain English on a 9th grade level.

KEEP IT SHORT:
- Maximum 2-3 sentences per response
- Use simple 10th grade language 
- Be direct and practical
- Use **bold** for key numbers, deadlines, percentages, or dollar amounts

TONE:
- Friendly but not overly chatty
- Skip "thank you for your service" unless they mention being a veteran
- Don't ask follow-up questions unless their question is unclear
- End responses naturally - no robotic "What else can I help with?"

GOOD EXAMPLES:
Question: "What are VA disability ratings?"
Answer: "VA disability ratings range from **0% to 100%** in 10% steps. Higher ratings mean bigger monthly payments. The VA combines multiple conditions using their special math formula."

Question: "How long do appeals take?"
Answer: "Most VA appeals take **12-18 months** to complete. The Higher-Level Review lane is usually fastest at about **4-5 months**."

BAD EXAMPLES (too long):
"The Department of Veterans Affairs disability compensation system is designed to provide monetary benefits to veterans who have sustained injuries or illnesses during their military service. The rating system ranges from 0% to 100% and is calculated using a complex formula that takes into account multiple conditions..."

Stay concise and helpful.`;

  // ========== Security Functions ==========
  function sanitizeInput(input) {
    if (!input || typeof input !== 'string') return '';
    
    return input
      .replace(/</g, '&lt;')
      .replace(/>/g, '&gt;')
      .replace(/"/g, '&quot;')
      .replace(/'/g, '&#x27;')
      .trim();
  }
  
  function validateInput(input) {
    const sanitized = sanitizeInput(input);
    
    if (sanitized.length > 500) {
      throw new Error('Message too long (max 500 characters)');
    }
    
    const suspiciousPatterns = [
      /<script/i,
      /javascript:/i,
      /on\w+\s*=/i,
      /data:text\/html/i,
      /vbscript:/i
    ];
    
    for (const pattern of suspiciousPatterns) {
      if (pattern.test(input)) {
        throw new Error('Invalid content detected');
      }
    }
    
    return sanitized;
  }
  
  function validateURL(url) {
    try {
      const urlObj = new URL(url);
      return ['http:', 'https:'].includes(urlObj.protocol);
    } catch {
      return false;
    }
  }
  
  function validateEmail(email) {
    const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
    const sanitized = sanitizeInput(email);
    
    if (!emailRegex.test(sanitized) || sanitized.length > 254) {
      throw new Error('Invalid email format');
    }
    
    return sanitized;
  }
  
  class RateLimiter {
    constructor(maxRequests = 10, windowMs = 60000) {
      this.maxRequests = maxRequests;
      this.windowMs = windowMs;
      this.requests = [];
    }
    
    isAllowed() {
      const now = Date.now();
      this.requests = this.requests.filter(time => now - time < this.windowMs);
      
      if (this.requests.length >= this.maxRequests) {
        return false;
      }
      
      this.requests.push(now);
      return true;
    }
    
    getTimeUntilReset() {
      if (this.requests.length === 0) return 0;
      const oldestRequest = Math.min(...this.requests);
      return Math.max(0, this.windowMs - (Date.now() - oldestRequest));
    }
  }

  const rateLimiter = new RateLimiter(10, 60000);
  // ========== END: Security Functions ==========

// ========== Chat History Management ==========
function buildChatHistory(messages, userMessage, maxTokens = 6000) {
  const estimatedTokenLength = (text) => Math.ceil(text.length / 4);
  let totalTokens = estimatedTokenLength(userMessage) + estimatedTokenLength(systemPrompt);
  const history = [];

  // Optionally add system prompt first, if your API supports it.
  // history.push({ role: "system", parts: [{ text: systemPrompt }] });

  // Add previous chat history (if any), but never let the first be a model
  for (let i = messages.length - 1; i >= 0; i--) {
    const msg = messages[i];
    if (msg.sender !== "user" && msg.sender !== "bot") continue;
    const role = msg.sender === "user" ? "user" : "model";
    const content = msg.text;
    const tokenCount = estimatedTokenLength(content);

    if (totalTokens + tokenCount > maxTokens) break;

    history.push({ role, parts: [{ text: content }] });
    totalTokens += tokenCount;
  }

  // Always add the current user message as the last entry
  history.push({
    role: "user",
    parts: [{ text: userMessage }]
  });

  // Reverse if needed (depending on your API's expected order)
  return history.reverse();
}

// ========== END: Chat History Management ==========  // Level 1: Simple overview questions
function extractTopic(text) {
  const lowerText = text.toLowerCase();
  
  if (lowerText.includes('claim') || lowerText.includes('file')) return 'filing';
  if (lowerText.includes('appeal') || lowerText.includes('decision')) return 'appeals';
  if (lowerText.includes('disability') || lowerText.includes('rating')) return 'disability';
  if (lowerText.includes('healthcare') || lowerText.includes('hospital')) return 'healthcare';
  if (lowerText.includes('education') || lowerText.includes('gi bill')) return 'education';
  if (lowerText.includes('home') || lowerText.includes('loan')) return 'housing';
  if (lowerText.includes('eligib') || lowerText.includes('qualify')) return 'eligibility';
  
  return null;
}
const initialQuickActions = [
    { text: "What are VA disability ratings?", label: "Disability Ratings", topic: "disability" },
    { text: "How do VA appeals work?", label: "Appeals Process", topic: "appeals" },
    { text: "What is VA healthcare coverage?", label: "Healthcare", topic: "healthcare" },
    { text: "What VA benefits am I eligible for?", label: "Eligibility", topic: "eligibility" },
    { text: "How do I file VA claims online?", label: "Filing Claims", topic: "filing" }
  ];

  // Level 2: Follow-up actions based on topic
  function getFollowUpActions(topic) {
    const followUpMap = {
      disability: [
        { text: "How is the combined rating calculated?", label: "Rating Math" },
        { text: "What counts as service-connected?", label: "Service Connection" },
        { text: "How do I increase my rating?", label: "Rating Increase" },
        { text: "What is P&T status?", label: "P&T Status" }
      ],
      appeals: [
        { text: "What are the appeal deadlines?", label: "Deadlines" },
        { text: "Which appeal lane should I choose?", label: "Appeal Options" },
        { text: "What evidence do I need for appeals?", label: "Evidence" },
        { text: "How long do appeals take?", label: "Timeline" }
      ],
      healthcare: [
        { text: "What are the priority groups?", label: "Priority Groups" },
        { text: "How do I enroll in VA healthcare?", label: "Enrollment" },
        { text: "Can I use non-VA providers?", label: "Community Care" },
        { text: "What about mental health services?", label: "Mental Health" }
      ],
      eligibility: [
        { text: "What are the service requirements?", label: "Service Requirements" },
        { text: "What benefits do family members get?", label: "Family Benefits" },
        { text: "How does discharge status affect benefits?", label: "Discharge Status" },
        { text: "What if I was National Guard or Reserve?", label: "Guard/Reserve" }
      ],
      filing: [
        { text: "What forms do I need to file?", label: "Required Forms" },
        { text: "How do I use VA.gov?", label: "VA.gov Guide" },
        { text: "What evidence should I submit?", label: "Evidence" },
        { text: "How do I track my claim status?", label: "Track Claims" }
      ],
      education: [
        { text: "How does the GI Bill work?", label: "GI Bill Basics" },
        { text: "What schools are approved?", label: "Approved Schools" },
        { text: "Can I transfer benefits to family?", label: "Transfer Benefits" },
        { text: "What about vocational training?", label: "Vocational Training" }
      ],
      housing: [
        { text: "How do VA home loans work?", label: "Home Loans" },
        { text: "What are the eligibility requirements?", label: "Loan Eligibility" },
        { text: "Do I need a down payment?", label: "Down Payment" },
        { text: "What about refinancing?", label: "Refinancing" }
      ]
    };
    
    return followUpMap[topic] || [];
  }

  // Level 3: Deep dive actions (always available)
  const deepDiveActions = [
    { text: "Show me the step-by-step process", label: "Step-by-Step" },
    { text: "What are common mistakes to avoid?", label: "Avoid Mistakes" },
    { text: "What resources can help me?", label: "Resources" },
    { text: "Email me this information", label: "Email Summary" }
  ];

  // Main function to get current quick actions
  function getCurrentQuickActions(messages, showDeepDive = true) {
    if (messages.length === 0) {
      return initialQuickActions;
    }
    
    // Get the last bot response to determine follow-ups
    const lastBotMessage = messages.slice().reverse().find(m => m.sender === "bot");
    const lastUserMessage = messages.slice().reverse().find(m => m.sender === "user");
    
    if (!lastBotMessage || !lastUserMessage) {
      return initialQuickActions;
    }
    
    // Extract topic from the conversation
    const topic = extractTopic(lastUserMessage.text) || extractTopic(lastBotMessage.text);
    
    if (topic) {
      const followUps = getFollowUpActions(topic);
      
      if (showDeepDive && followUps.length > 0) {
        return [
          ...followUps,
          { text: "Ask about something else", label: "New Topic", action: "reset" },
          ...deepDiveActions.slice(0, 2) // Show first 2 deep dive options
        ];
      }
      
      return followUps.length > 0 ? followUps : initialQuickActions;
    }
    
    return initialQuickActions;
  }
  // ========== END: Progressive Quick Actions System ==========
  
function renderMarkdown(text) {
  try {
    const sanitized = sanitizeInput(text);
    return marked.parse(sanitized);
  } catch (err) {
    return `<p>${sanitizeInput(text)}</p>`;
  }
}
  
  const isDev = window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1';
  function logToConsole(message, data) { 
    if (isDev) console.log(`[VetDesk] ${message}:`, data); 
  }
  
  async function fetchWithRetry(url, options = {}, maxRetries = 3) {
    for (let i = 0; i < maxRetries; i++) {
      try {
        const response = await fetch(url, options);
        if (!response.ok) throw new Error(`HTTP ${response.status}`);
        return response;
      } catch (error) {
        logToConsole(`Fetch attempt ${i + 1} failed for ${url}`, error.message);
        if (i === maxRetries - 1) throw error;
        await new Promise(resolve => setTimeout(resolve, Math.pow(2, i) * 1000));
      }
    }
  }
  
  const isValidEmail = (email) => /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email);
  
  function Landing({ onTryNow }) {
    return (
      <section className="flex flex-col justify-center h-screen px-6 bg-gradient-to-br from-slate-100 to-slate-200">
        <div className="max-w-4xl mx-auto">
          <div className="text-sm font-bold text-slate-600 uppercase mb-6">VETDESK‚Ñ¢</div>
          <h1 className="text-5xl font-extrabold text-slate-900 mb-6">Get the Facts Fast.</h1>
          <p className="text-lg text-slate-700 mb-4">VetDesk breaks down veteran benefits and the policies that affect them - giving you immediate answers that make sense without creating an account.</p>
          <p className="text-lg text-slate-700 mb-8">It's clarity, confidence, and control. Built for veterans who need answers - not more questions.</p>
          <button onClick={onTryNow} className="bg-blue-800 hover:bg-blue-900 text-white font-semibold px-6 py-3 rounded-md shadow-md transition">
            Try Now
          </button>
        </div>
      </section>
    );
  }
  
  function NewsPanel({ onAsk, isMobileOpen, onMobileClose }) {
    const [articles, setArticles] = React.useState([]);
    const [loading, setLoading] = React.useState(true);
    const [newsRefresh, setNewsRefresh] = React.useState(0);
    const [error, setError] = React.useState(null);
  
    const fetchNews = React.useCallback(async () => {
      setLoading(true);
      setError(null);
      logToConsole("Fetching news", { refresh: newsRefresh });
      try {
        const response = await fetchWithRetry("https://vetdesk-demo2-api.vercel.app/api/va-news");
        const data = await response.json();
        setArticles(data.sources || []);
        logToConsole("News loaded", data.sources?.length || 0);
      } catch (err) {
        logToConsole("News fetch error", err);
        setError("Unable to load news. Please try again later.");
        setArticles([]);
      } finally {
        setLoading(false);
      }
    }, [newsRefresh]);
  
    React.useEffect(() => {
      fetchNews();
    }, [fetchNews]);
  
    return (
      <aside className={`news-panel w-full md:w-[400px] border-r border-slate-200 bg-white h-full overflow-y-auto p-4 ${isMobileOpen ? 'open' : ''}`}>
        <div className="flex justify-between items-center mb-4">
          <h2 className="text-xl font-bold text-slate-800">Veterans News</h2>
          <div className="flex gap-2 items-center">
            {isMobileOpen && (
              <button onClick={onMobileClose} className="text-slate-500 hover:text-slate-700 md:hidden" aria-label="Close news panel">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
                  <line x1="18" y1="6" x2="6" y2="18"></line>
                  <line x1="6" y1="6" x2="18" y2="18"></line>
                </svg>
              </button>
            )}
          </div>
        </div>
  
        {error ? (
          <div className="text-red-600 text-sm bg-red-50 p-3 rounded">{error}</div>
        ) : loading ? (
          <div className="space-y-6">
            {[...Array(3)].map((_, idx) => (
              <div key={idx} className="animate-pulse">
                <div className="h-36 bg-gray-300 rounded mb-2"></div>
                <div className="h-4 bg-gray-300 rounded mb-1"></div>
                <div className="h-3 bg-gray-300 rounded w-3/4"></div>
              </div>
            ))}
          </div>
        ) : articles.length ? (
          articles.map((article, idx) => {
            const formattedDate = new Date(article.pubDate).toLocaleDateString(undefined, {
              year: 'numeric',
              month: 'short',
              day: 'numeric'
            });
  
            return (
              <div key={idx} className="mb-4">
                <div className="bg-white shadow-sm hover:shadow-md rounded-lg p-4 transition duration-200 border border-slate-100">
                  {article.image && (
                    <img
                      src={article.image}
                      alt={article.title}
                      loading="lazy"
                      className="mb-3 w-full h-40 object-cover rounded-lg border border-gray-200"
                      onError={(e) => {
                        e.target.style.display = 'none';
                        e.target.removeAttribute('src');
                      }}
                    />
                  )}
                  <h3 className="text-lg font-semibold text-slate-800 mb-1 line-clamp-2">
                    {article.title}
                  </h3>
                  <p className="text-xs text-slate-500 italic">{formattedDate} ‚Ä¢ {article.source}</p>
                  <button
                    onClick={() => {
                      onAsk(`How does this news affect my benefits: "${article.title}"`);
                      onMobileClose();
                    }}
                    className="mt-4 w-full bg-blue-600 hover:bg-blue-700 text-white text-sm font-semibold py-2 rounded-md transition shadow-sm"
                  >
                    How does this affect me?
                  </button>
                </div>
              </div>
            );
          })
        ) : (
          <div className="text-slate-400 text-sm text-center py-8">
            <p>No news articles available.</p>
          </div>
        )}
      </aside>
    );
  }
  
  function ChatbotPanel({
    messages, input, setInput, onSend, streaming, isLoading, emailState, onQuickAsk, textSize, setTextSize, onClearChat
  }) {
    const textareaRef = React.useRef(null);
    const messagesEndRef = React.useRef(null);
    const [lastSent, setLastSent] = React.useState(0);
    const [inputError, setInputError] = React.useState('');
    const [showStartupTip, setShowStartupTip] = React.useState(true);

    // Progressive Quick Actions State
    const [currentActions, setCurrentActions] = React.useState(initialQuickActions);
    const [showQuickActions, setShowQuickActions] = React.useState(true);
    const [loadingAction, setLoadingAction] = React.useState(null);

    const chatStarted = messages.length > 0;
    const charCount = input.length;
    const maxChars = 500;

    // Update actions based on conversation context
    React.useEffect(() => {
      const newActions = getCurrentQuickActions(messages);
      setCurrentActions(newActions);
    }, [messages]);

    React.useEffect(() => {
      const container = messagesEndRef.current?.parentNode;
      if (!container) return;

      const nearBottom = container.scrollHeight - container.scrollTop - container.clientHeight < 100;

      if (nearBottom) {
        messagesEndRef.current.scrollIntoView({ behavior: "smooth" });
      }
    }, [messages, streaming]);

    React.useEffect(() => { 
      if (!isLoading && !streaming) setLoadingAction(null); 
    }, [isLoading, streaming]);

    function handleSend() {
      const now = Date.now();
      if (now - lastSent < 1000) return;

      const trimmed = input.trim();
      if (!trimmed) return;

      setLastSent(now);
      setInputError('');

      onSend(trimmed);  // App will handle all validation
      setInput("");
    }

    const handleQuickAsk = (action, idx) => {
      setLoadingAction(idx);
      
      if (action.action === "reset") {
        setCurrentActions(initialQuickActions);
        return;
      }
      
      onQuickAsk(action.text);
    };

    return (
      <main className="flex flex-col flex-1 h-full text-large">
        <div className="border-b border-slate-200 bg-white px-4 pt-3 pb-2">
          <div className="quick-actions flex flex-wrap justify-center gap-2">
            {showQuickActions && currentActions.map((action, idx) => (
              <button
                key={idx}
                onClick={() => handleQuickAsk(action, idx)}
                disabled={isLoading || streaming || loadingAction === idx}
                className={`px-3 py-2 rounded-md text-sm font-medium transition ${
                  loadingAction === idx 
                    ? 'bg-blue-200 text-blue-500' 
                    : action.action === 'reset'
                    ? 'bg-gray-100 text-gray-700 hover:bg-gray-200'
                    : 'bg-blue-100 text-blue-700 hover:bg-blue-200'
                }`}
              >
                {loadingAction === idx ? 'Loading...' : action.label}
              </button>
            ))}
            <button
              onClick={() => setShowQuickActions(!showQuickActions)}
              title={showQuickActions ? "Hide quick actions" : "Show quick actions"}
              className="p-1 text-blue-800 hover:text-blue-900"
            >
              {showQuickActions ? '‚¨ÜÔ∏è' : '‚¨áÔ∏è'}
            </button>
          </div>
        </div>

        {!chatStarted && !emailState?.waitingForEmail && (
          <div className="flex flex-1 items-center justify-center">
            <div className="text-center px-6 max-w-2xl">
              <h2 className="text-2xl font-bold text-gray-800 mb-3">Welcome to VetDesk</h2>
              <p className="text-lg text-gray-600 mb-2">Get clear, plain-English answers about your VA benefits and what's changing.</p>
              <p className="text-sm text-gray-500 italic">This conversation isn't saved. Don't refresh or close the page unless you're done.</p>
            </div>
          </div>
        )}

        <div className="flex-1 px-4 py-2 space-y-2 overflow-y-auto">
          {messages.map((msg, idx) => (
            <div key={idx} className={`message-row ${msg.sender}`}>
              <div className={`message-bubble ${msg.sender}`}>
                <div className={`message-content ${msg.sender}`}>
                  <div dangerouslySetInnerHTML={{ __html: renderMarkdown(msg.text) }} />
                </div>
              </div>
            </div>
          ))}
          {(isLoading || streaming) && (
            <div className="message-row bot typing-indicator-row">
              <div className="message-bubble bot">
                <div className="message-content bot">
                  <div className="typing-dots">
                    <div className="typing-dot"></div>
                    <div className="typing-dot"></div>
                    <div className="typing-dot"></div>
                  </div>
                </div>
              </div>
            </div>
          )}
          <div ref={messagesEndRef}></div>
        </div>

        <div className="border-t p-4 bg-white">
          {inputError && (
            <div className="text-red-600 text-sm mb-2 p-2 bg-red-50 rounded">
              {inputError}
            </div>
          )}
          {charCount > maxChars * 0.8 && (
            <div className={`text-xs text-right mb-1 ${charCount > maxChars ? 'text-red-500' : 'text-gray-500'}`}>
              {charCount}/{maxChars} characters
            </div>
          )}
          {showStartupTip && (
            <div className="mb-3 p-3 bg-blue-50 border border-blue-200 rounded-md text-sm text-blue-800">
              üí° <strong>Quick Start:</strong>This conversation isn't saved. Refreshing or closing the page will erase your information.
            </div>
          )}
          <div className="flex gap-2">
            <textarea
              ref={textareaRef}
              value={input}
              onChange={e => {
                setInput(e.target.value);
                if (inputError) setInputError('');
                if (showStartupTip && e.target.value.trim().length > 0) {
                  setShowStartupTip(false);
                }
              }}
              rows="2"
              maxLength={maxChars}
              className="flex-1 p-2 border border-gray-300 rounded-md resize-none focus:outline-none focus:ring-2 focus:ring-blue-500"
              placeholder={emailState.waitingForEmail ? "Enter your email address..." : "Type your question..."}
              onKeyDown={e => {
                if (e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); handleSend(); }
                if (e.key === 'Escape') setInput('');
              }}
              disabled={isLoading || streaming}
            />
            <button
              onClick={handleSend}
              disabled={!input.trim() || isLoading || streaming || charCount > maxChars}
              className="bg-blue-800 hover:bg-blue-900 disabled:bg-gray-400 text-white px-4 py-2 rounded-md font-semibold transition"
            >
              Send
            </button>
            <button
              onClick={() => onQuickAsk("Please email me the last response")}
              disabled={
                messages.length === 0 ||
                messages[messages.length - 1].sender !== 'bot' ||
                isLoading || streaming
              }
              className="bg-blue-700 hover:bg-blue-800 disabled:bg-gray-300 text-white px-3 py-2 rounded-md text-sm"
            >
              Email Summary
            </button>
          </div>
        </div>
      </main>
    );
  }

function App() {
  const [messages, setMessages] = React.useState([]);
  const [started, setStarted] = React.useState(false);
  const [input, setInput] = React.useState("");
  const [isLoading, setIsLoading] = React.useState(false);
  const [streaming, setStreaming] = React.useState(false);
  const [textSize, setTextSize] = React.useState("large");
  const streamingIntervalRef = React.useRef(null);
  const [emailState, setEmailState] = React.useState({
    waitingForEmail: false,
    lastBotResponse: null,
    lastUserQuestion: null
  });
  const [hasError, setHasError] = React.useState(false);

  // Clean up streaming interval on unmount
  React.useEffect(() => {
    return () => {
      if (streamingIntervalRef.current) {
        clearTimeout(streamingIntervalRef.current);
      }
    };
  }, []);

  // Warn user before unloading if chat active
  React.useEffect(() => {
    const handleBeforeUnload = (e) => {
      if (messages.length > 0) {
        e.preventDefault();
        e.returnValue = "";
      }
    };
    window.addEventListener("beforeunload", handleBeforeUnload);
    return () => window.removeEventListener("beforeunload", handleBeforeUnload);
  }, [messages]);

  // Global error handler
  React.useEffect(() => {
    const handleError = (error) => {
      console.error('App error:', error);
      setHasError(true);
    };
    window.addEventListener('error', handleError);
    return () => window.removeEventListener('error', handleError);
  }, []);

  // Streaming bot typing effect
  function streamBotText(botText, originalQuestion) {
    if (streamingIntervalRef.current) clearTimeout(streamingIntervalRef.current);
    setStreaming(true);

    let index = 0;
    function typeNextChar() {
      index++;
      setMessages((prev) => {
        const updated = [...prev];
        updated[updated.length - 1] = {
          text: botText.slice(0, index),
          sender: "bot"
        };
        return updated;
      });

      if (index < botText.length) {
        streamingIntervalRef.current = setTimeout(typeNextChar, 5);
      } else {
        streamingIntervalRef.current = null;
        setStreaming(false);
        setIsLoading(false);
      }
    }
    typeNextChar();
  }

  // Email subject extraction
  function extractTopicFromQuestion(question) {
    const q = question ? question.toLowerCase() : "";
    if (q.includes("claim")) return "VA Claims Process";
    if (q.includes("appeal")) return "VA Appeals Process";
    if (q.includes("disability")) return "Disability Benefits";
    return "VA Benefits Information";
  }

  // Main Gemini chat/email logic
  async function sendMessageToGemini(userMessage) {
    try {
      const sanitized = validateInput(userMessage);

      if (!rateLimiter.isAllowed()) {
        const resetTime = Math.ceil(rateLimiter.getTimeUntilReset() / 1000);
        setMessages(prev => [
          ...prev,
          {
            text: `Please wait ${resetTime} seconds before sending another message.`,
            sender: "bot"
          }
        ]);
        return;
      }

      if (emailState.waitingForEmail) {
        // Email mode
        try {
          const validatedEmail = validateEmail(sanitized);
          setIsLoading(true);
          logToConsole("Sending email", { email: validatedEmail });

          const subject = extractTopicFromQuestion(emailState.lastUserQuestion);
          const res = await fetch("https://vetdesk-demo2-api.vercel.app/api/send-summary", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
              email: validatedEmail,
              subject,
              content: emailState.lastBotResponse,
              userName: "Veteran"
            })
          });
          const result = await res.json();

          if (!res.ok || !result.success) {
            throw new Error(result.error || "Email send failed");
          }

          setMessages(prev => [...prev, { text: "‚úÖ Summary sent to your email.", sender: "bot" }]);
          setEmailState({
            waitingForEmail: false,
            lastBotResponse: null,
            lastUserQuestion: null
          });

        } catch (error) {
          console.error("Email send error:", error);
          setMessages(prev => [...prev, {
            text: "‚ùå Failed to send email. Please check your address and try again in a moment.",
            sender: "bot"
          }]);
        } finally {
          setIsLoading(false);
        }
      } else {
        // Normal chat mode
        setIsLoading(true);
        setMessages(prev => [...prev, { text: sanitized, sender: "user" }]);
        try {
          const res = await fetch("https://vetdesk-demo2-api.vercel.app/api/chat", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
              chatHistory: buildChatHistory(messages, sanitized)              
            })
          });

          const data = await res.json();
          const botReply = data?.candidates?.[0]?.content?.parts?.[0]?.text || "Sorry, I couldn't generate a response.";

          setMessages(prev => [...prev, { text: "", sender: "bot" }]);
          streamBotText(botReply, sanitized);

        } catch (error) {
          console.error("Chat error:", error);
          setMessages(prev => [...prev, {
            text: "‚ùå There was a problem getting your answer. Please try again.",
            sender: "bot"
          }]);
          setIsLoading(false);
          setStreaming(false);
        }
      }
    } catch (error) {
      console.error("Message processing error:", error);
      setMessages(prev => [...prev, { 
        text: "Please check your message and try again.", 
        sender: "bot" 
      }]);
      setIsLoading(false);
    }
  }

  // Handle quick ask events
  const handleQuickAsk = (questionText) => {
    if (!questionText || isLoading || streaming) return;
    logToConsole('Quick ask clicked:', questionText);
    logToConsole('Current messages count:', messages.length);

    if (questionText.toLowerCase().includes("email me")) {
      const lastBotMessage = messages.slice().reverse().find(m => m.sender === "bot");
      if (lastBotMessage) {
        setEmailState({
          waitingForEmail: true,
          lastBotResponse: lastBotMessage.text,
          lastUserQuestion: questionText
        });
        setMessages(prev => [...prev, 
          { text: questionText, sender: "user" },
          { text: "Please enter your email address to receive the summary.", sender: "bot" }
        ]);
        return;
      } else {
        setMessages(prev => [...prev, 
          { text: questionText, sender: "user" },
          { text: "I don't have any information to email yet. Please ask me a question first!", sender: "bot" }
        ]);
        return;
      }
    }
    
    sendMessageToGemini(questionText);
  };

  // Clear chat and reset state
  const handleClearChat = () => {
    setMessages([]);
    setEmailState({
      waitingForEmail: false,
      lastBotResponse: null,
      lastUserQuestion: null
    });
    setStarted(false); // Ensures app resets to landing page
    logToConsole('Chat cleared');
  };

  // Error boundary UI
  if (hasError) {
    return (
      <div className="flex items-center justify-center h-screen">
        <div className="text-center">
          <h2 className="text-xl font-bold mb-4">Something went wrong</h2>
          <button 
            onClick={() => {
              setHasError(false);
              handleClearChat();
            }}
            className="bg-blue-800 text-white px-4 py-2 rounded-md"
          >
            Reset App
          </button>
        </div>
      </div>
    );
  }

  // Main UI
  return (
    <div className="flex flex-col h-screen w-full overflow-hidden">
      {!started ? (
        <div className="flex-1 overflow-auto">
          <Landing onTryNow={() => setStarted(true)} />
        </div>
      ) : (
        <div className="flex h-full flex-1">
          <NewsPanel
            isMobileOpen={false}
            onMobileClose={() => {}}
            onAsk={handleQuickAsk}
          />
          <div className="flex-1 overflow-hidden">
            <ChatbotPanel
              messages={messages || []}
              input={input}
              setInput={setInput}
              onSend={(msg) => {
                const trimmed = (msg ?? "").trim();
                if (trimmed) sendMessageToGemini(trimmed);
              }}
              streaming={streaming}
              isLoading={isLoading}
              emailState={emailState}
              onQuickAsk={handleQuickAsk}
              textSize={textSize}
              setTextSize={setTextSize}
              onClearChat={handleClearChat}
            />
          </div>
        </div>
      )}
    </div>
  );
}ReactDOM.createRoot(document.getElementById("root")).render(<App />);
  </script>
</body>
</html>