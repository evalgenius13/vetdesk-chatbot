<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>VetDesk Chat</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta http-equiv="Content-Security-Policy" content="default-src 'self'; script-src 'self' 'unsafe-inline' https://cdn.tailwindcss.com; style-src 'self' 'unsafe-inline' https://cdn.tailwindcss.com; connect-src 'self' https://vetdesk-demo2-api.vercel.app; font-src 'self' data:; object-src 'none'; base-uri 'self'; form-action 'self';">
  <meta http-equiv="X-Content-Type-Options" content="nosniff">
  <meta http-equiv="Referrer-Policy" content="strict-origin-when-cross-origin">
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    @media (max-width: 768px) {
      #news-feed-section {
        display: none;
      }
      #chat-section {
        flex: 1 1 100%;
      }
    }
    .chat-bubble-user {
      max-width: 42rem;
      background: #1e40af;
      color: white;
      border-radius: 1rem;
      padding: 1rem 1.25rem;
      line-height: 1.6;
      white-space: pre-line;
      margin-left: auto;
      word-break: break-word;
    }
    .chat-bubble-bot {
      max-width: 42rem;
      background: #f9fafb;
      color: #1f2937;
      border-radius: 1rem;
      box-shadow: 0 1px 3px rgba(0,0,0,0.1);
      padding: 1.5rem;
      line-height: 1.6;
      white-space: pre-line;
      word-break: break-word;
      border: 1px solid #e5e7eb;
    }
    .chat-bubble-bot p {
      margin-bottom: 1rem;
    }
    .chat-bubble-bot p:last-child {
      margin-bottom: 0;
    }
    .spinner {
      border: 3px solid #e5e7eb;
      border-top: 3px solid #1e40af;
      border-radius: 50%;
      width: 20px;
      height: 20px;
      animation: spin 1s linear infinite;
      margin: auto;
    }
    @keyframes spin {
      0% { transform: rotate(0deg);}
      100% { transform: rotate(360deg);}
    }
    #chat-history {
      scroll-behavior: smooth;
    }
    .message-container {
      margin-bottom: 1.5rem;
    }
    .error-message {
      background: #fef2f2;
      border: 1px solid #fecaca;
      color: #dc2626;
      padding: 1rem;
      border-radius: 0.5rem;
      margin: 1rem 0;
    }
    .news-loading {
      background: #f9fafb;
      border: 1px solid #e5e7eb;
      border-radius: 0.5rem;
      padding: 1rem;
      text-align: center;
      color: #6b7280;
    }
    .news-error {
      background: #fef2f2;
      border: 1px solid #fecaca;
      color: #dc2626;
      padding: 1rem;
      border-radius: 0.5rem;
      text-align: center;
    }
    .news-item {
      transition: all 0.2s ease;
    }
    .news-item:hover {
      transform: translateY(-1px);
      box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    }
  </style>
</head>
<body class="bg-gray-100 h-screen flex flex-col">

  <header class="bg-blue-900 text-white p-4 flex items-center justify-between">
    <h1 class="text-2xl font-bold">VetDeskâ„¢</h1>
    <span class="text-sm font-medium">VA Benefits, Simplified.</span>
  </header>

  <main class="flex-1 flex flex-col md:flex-row overflow-hidden">

    <!-- News Feed -->
    <section id="news-feed-section" class="w-full md:w-80 bg-white border-r border-gray-200 overflow-y-auto p-4 flex flex-col min-w-[0]">
      <h2 class="text-xl font-semibold mb-3">Veteran News Feed</h2>
      <ul id="news-feed" class="space-y-4 flex-1"></ul>
    </section>

    <!-- Chat Section -->
    <section id="chat-section" class="flex-1 flex flex-col h-full bg-gray-50">
      <div id="welcome-message" class="p-4 text-base text-gray-700 bg-white border-b border-gray-200">
        <span>ðŸ‘‹ Hi there, and welcome! I'm here to help you understand your VA benefits in plain everyday English. When you know your benefits, you can help other veterans too. Just ask me any questions you have.</span>
      </div>
      <div id="quick-actions" class="flex flex-wrap gap-2 p-4 bg-white border-b border-gray-200"></div>
      <div id="chat-history" class="flex-1 overflow-y-auto p-4" aria-live="polite"></div>
      <form id="chat-form" class="flex gap-2 p-4 bg-white border-t border-gray-200" autocomplete="off">
        <input id="chat-input" type="text" class="flex-1 border rounded-lg px-4 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent" placeholder="Ask me anything about VA benefits..." autocomplete="off" required aria-label="Chat input" maxlength="2000" />
        <button type="submit" id="send-button" class="bg-blue-700 text-white px-6 py-2 rounded-lg hover:bg-blue-800 transition-colors duration-200 disabled:opacity-50 disabled:cursor-not-allowed">Send</button>
      </form>
    </section>
  </main>

  <script>
    // Configuration
    const CONFIG = {
      API_URL: 'https://vetdesk-demo2-api.vercel.app/api/chat',
      NEWS_API_URL: 'https://vetdesk-demo2-api.vercel.app/api/news',
      FRONTEND_SECRET: 'vetdesk_secure_2025_kx9mR7pL3wQ8nF2vB6jC',
      MAX_MESSAGE_LENGTH: 2000,
      MAX_CONVERSATION_LENGTH: 50
    };

    const quickActions = [
      { text: "Tell me about VA disability benefits", label: "Disability" },
      { text: "What VA healthcare benefits are available?", label: "Healthcare" },
      { text: "Can you explain VA education benefits?", label: "Education" },
      { text: "What are VA housing benefits?", label: "Housing" },
      { text: "What new VA benefits or updates should I know about?", label: "What's New" }
    ];

    // ====== News Feed Management ======
    let newsItems = [];
    let newsLoading = false;

    async function fetchNews(forceRefresh = false) {
      if (newsLoading) return;

      newsLoading = true;
      const newsFeed = document.getElementById('news-feed');

      try {
        showNewsLoading();

        const response = await fetch(CONFIG.NEWS_API_URL, {
          method: 'GET',
          headers: {
            'Accept': 'application/json'
          }
        });

        if (!response.ok) {
          throw new Error(`HTTP ${response.status}`);
        }

        const data = await response.json();

        if (data.error && !data.articles?.length) {
          throw new Error(data.error);
        }

        newsItems = data.articles || [];
        renderNewsFeed();

      } catch (error) {
        console.error('News fetch error:', error);
        showNewsError(error.message);
      } finally {
        newsLoading = false;
      }
    }

    function showNewsLoading() {
      const feed = document.getElementById('news-feed');
      feed.innerHTML = '<li class="p-3 bg-gray-50 border rounded-lg text-center text-gray-500"><div class="spinner"></div><p class="mt-2">Loading news...</p></li>';
    }

    function showNewsError(message) {
      const feed = document.getElementById('news-feed');
      feed.innerHTML = `<li class="p-3 bg-red-50 border border-red-200 rounded-lg text-center text-red-600">Unable to load news</li>`;
    }

    function renderNewsFeed() {
      const feed = document.getElementById('news-feed');
      feed.innerHTML = "";

      if (!newsItems.length) {
        feed.innerHTML = '<li class="text-gray-500 text-center py-4">No news available</li>';
        return;
      }

      newsItems.forEach((item, idx) => {
        const li = document.createElement('li');
        li.className = "p-3 bg-gray-50 border rounded-lg shadow-sm hover:shadow-md transition-shadow";

        const titleText = escapeHtml(item.title);
        const summaryText = escapeHtml(item.summary);

        li.innerHTML = `
          <a href="${escapeHtml(item.url)}" class="font-semibold text-blue-800 hover:underline" target="_blank" rel="noopener noreferrer">${titleText}</a>
          ${item.date ? `<div class="text-xs text-gray-500 mb-1">${escapeHtml(item.date)}</div>` : ''}
          <div class="mb-2 text-sm">${summaryText}</div>
          <button type="button" class="how-affect-me-btn bg-green-100 text-green-800 px-3 py-1 rounded-md hover:bg-green-200 transition-colors text-sm font-medium" data-news-idx="${idx}">
            How does this affect me?
          </button>
        `;
        feed.appendChild(li);
      });

      // Attach event listeners for "How does this affect me?" buttons
      document.querySelectorAll('.how-affect-me-btn').forEach(btn => {
        btn.addEventListener('click', function() {
          const idx = parseInt(this.getAttribute('data-news-idx'));
          const news = newsItems[idx];
          if (news) {
            const userMessage = `How does "${news.title}" affect me?`;
            addUserMessageToChat(userMessage);
          }
        });
      });
    }

    // ====== Security Helper Functions ======
    function escapeHtml(text) {
      if (!text) return '';
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }

    function validateMessageLength(text) {
      return text && text.trim().length > 0 && text.length <= CONFIG.MAX_MESSAGE_LENGTH;
    }

    // ====== Render Quick Actions ======
    function renderQuickActions() {
      const qa = document.getElementById('quick-actions');
      qa.innerHTML = "";
      quickActions.forEach(action => {
        const btn = document.createElement('button');
        btn.type = "button";
        btn.className = "bg-blue-100 text-blue-900 px-3 py-2 rounded-lg hover:bg-blue-200 transition-colors text-sm font-medium";
        btn.textContent = action.label;
        btn.onclick = () => {
          addUserMessageToChat(action.text);
        };
        qa.appendChild(btn);
      });
    }

    // ====== Chat State ======
    let chatMessages = [];
    let botIsLoading = false;
    let rateLimitWarning = false;

    // ====== Error Handling ======
    function showError(message) {
      const ch = document.getElementById('chat-history');
      const errorDiv = document.createElement('div');
      errorDiv.className = "message-container";
      errorDiv.innerHTML = `<div class="error-message">${escapeHtml(message)}</div>`;
      ch.appendChild(errorDiv);
      ch.scrollTop = ch.scrollHeight;
    }

    // ====== Format Bot Message with Paragraphs ======
    function formatBotMessage(text) {
      const sanitized = escapeHtml(text);
      const paragraphs = sanitized.split('\n\n').filter(p => p.trim());
      if (paragraphs.length > 1) {
        return paragraphs.map(p => `<p>${p.trim()}</p>`).join('');
      }
      return sanitized;
    }

    // ====== Render Chat History with ChatGPT-style Formatting ======
    async function renderChatHistory() {
      const ch = document.getElementById('chat-history');
      ch.innerHTML = "";

      for (let i = 0; i < chatMessages.length; i++) {
        const msg = chatMessages[i];
        const messageDiv = document.createElement('div');
        messageDiv.className = "message-container";

        if (msg.sender === "user") {
          messageDiv.className += " flex justify-end";
          messageDiv.innerHTML = `<div class="chat-bubble-user">${escapeHtml(msg.text)}</div>`;
          ch.appendChild(messageDiv);
        } else if (msg.sender === "bot") {
          messageDiv.className += " flex justify-start";

          if (i === chatMessages.length - 1 && msg.streaming) {
            const botBubble = document.createElement('div');
            botBubble.className = "chat-bubble-bot";
            messageDiv.appendChild(botBubble);
            ch.appendChild(messageDiv);

            await streamBotText(msg.text, botBubble);
            msg.streaming = false;
          } else {
            const formattedText = formatBotMessage(msg.text);
            messageDiv.innerHTML = `<div class="chat-bubble-bot">${formattedText}</div>`;
            ch.appendChild(messageDiv);
          }
        }
      }

      // Loading spinner for pending bot reply
      if (botIsLoading) {
        const spinnerDiv = document.createElement('div');
        spinnerDiv.className = "message-container flex justify-center";
        spinnerDiv.innerHTML = `<div class="chat-bubble-bot flex items-center justify-center py-4"><div class="spinner" role="status" aria-label="Loading"></div></div>`;
        ch.appendChild(spinnerDiv);
      }

      ch.scrollTop = ch.scrollHeight;
    }

    // ====== Streaming Effect with Paragraph Support ======
    function streamBotText(text, container) {
      return new Promise(resolve => {
        const formattedText = formatBotMessage(text);
        let i = 0;
        const delay = 3;

        function typeChar() {
          if (formattedText.includes('<p>')) {
            container.innerHTML = formattedText;
            resolve();
          } else {
            container.textContent = text.slice(0, i + 1);
            i++;
            if (i < text.length) {
              setTimeout(typeChar, delay);
            } else {
              resolve();
            }
          }
        }
        typeChar();
      });
    }

    // ====== Secure API Integration ======
    async function getBotReply() {
      try {
        if (chatMessages.length > CONFIG.MAX_CONVERSATION_LENGTH) {
          throw new Error('Conversation too long. Please start a new conversation.');
        }

        const history = chatMessages.map(m => ({
          role: m.sender === "user" ? "user" : "model",
          parts: [{ text: m.text }]
        }));

        const response = await fetch(CONFIG.API_URL, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${CONFIG.FRONTEND_SECRET}`
          },
          body: JSON.stringify({ chatHistory: history })
        });

        if (response.status === 429) {
          if (!rateLimitWarning) {
            rateLimitWarning = true;
            setTimeout(() => { rateLimitWarning = false; }, 60000);
          }
          throw new Error('Too many requests. Please wait a moment before trying again.');
        }

        if (response.status === 401) {
          throw new Error('Authentication failed. Please refresh the page.');
        }

        if (!response.ok) {
          throw new Error(`Server error (${response.status}). Please try again later.`);
        }

        const data = await response.json();

        return (
          data?.candidates?.[0]?.content?.parts?.[0]?.text ||
          "Sorry, I couldn't get an answer right now."
        );
      } catch (e) {
        console.error('API Error:', e);

        if (e.message.includes('fetch')) {
          return "Sorry, I'm having trouble connecting. Please check your internet connection and try again.";
        }

        return e.message || "Sorry, something went wrong. Please try again later.";
      }
    }

    // ====== Chat Functions with Validation ======
    function addUserMessageToChat(text) {
      const trimmedText = text.trim();

      if (!validateMessageLength(trimmedText)) {
        showError(`Message must be between 1 and ${CONFIG.MAX_MESSAGE_LENGTH} characters.`);
        return;
      }

      if (chatMessages.length >= CONFIG.MAX_CONVERSATION_LENGTH) {
        showError('Conversation limit reached. Please refresh to start a new conversation.');
        return;
      }

      if (botIsLoading) {
        showError('Please wait for the current response to finish.');
        return;
      }

      chatMessages.push({ sender: "user", text: trimmedText });
      renderChatHistory();
      addBotReplyToChat();
    }

    async function addBotReplyToChat() {
      botIsLoading = true;
      const sendButton = document.getElementById('send-button');
      const chatInput = document.getElementById('chat-input');

      sendButton.disabled = true;
      chatInput.disabled = true;

      await renderChatHistory();

      const botReply = await getBotReply();

      botIsLoading = false;
      sendButton.disabled = false;
      chatInput.disabled = false;

      chatInput.focus();

      chatMessages.push({ sender: "bot", text: botReply, streaming: true });
      await renderChatHistory();
    }

    // ====== Event Listeners ======
    document.getElementById('chat-form').addEventListener('submit', async (e) => {
      e.preventDefault();
      const input = document.getElementById('chat-input');
      const text = input.value.trim();

      if (!text) return;

      if (!validateMessageLength(text)) {
        showError(`Message must be between 1 and ${CONFIG.MAX_MESSAGE_LENGTH} characters.`);
        return;
      }

      addUserMessageToChat(text);
      input.value = "";
    });

    document.getElementById('chat-input').addEventListener('input', function(e) {
      const length = e.target.value.length;
      const button = document.getElementById('send-button');

      if (length > CONFIG.MAX_MESSAGE_LENGTH) {
        e.target.value = e.target.value.substring(0, CONFIG.MAX_MESSAGE_LENGTH);
      }

      button.disabled = e.target.value.trim().length === 0 || botIsLoading;
    });

    // ====== Initialize ======
    document.addEventListener('DOMContentLoaded', () => {
      renderQuickActions();
      renderChatHistory();
      fetchNews();
      document.getElementById('chat-input').focus();
    });

    // Keyboard shortcuts
    document.addEventListener('keydown', function(e) {
      if ((e.ctrlKey || e.metaKey) && e.key === 'Enter') {
        document.getElementById('chat-form').dispatchEvent(new Event('submit'));
      }
    });

  </script>
</body>
</html>
