<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>VetDesk Chat</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    @media (max-width: 768px) {
      #news-feed-section {
        display: none;
      }
      #chat-section {
        flex: 1 1 100%;
      }
    }
    
    /* ChatGPT-style chat bubbles */
    .chat-bubble-user {
      max-width: 42rem;
      background: #1e40af;
      color: white;
      border-radius: 1rem;
      padding: 1rem 1.25rem;
      line-height: 1.6;
      white-space: pre-line;
      margin-left: auto;
      word-break: break-word;
    }
    
    .chat-bubble-bot {
      max-width: 42rem;
      background: #f9fafb;
      color: #1f2937;
      border-radius: 1rem;
      box-shadow: 0 1px 3px rgba(0,0,0,0.1);
      padding: 1.5rem;
      line-height: 1.6;
      white-space: pre-line;
      word-break: break-word;
      border: 1px solid #e5e7eb;
    }
    
    /* Improve paragraph spacing within bot messages */
    .chat-bubble-bot p {
      margin-bottom: 1rem;
    }
    
    .chat-bubble-bot p:last-child {
      margin-bottom: 0;
    }
    
    /* Loading spinner */
    .spinner {
      border: 3px solid #e5e7eb;
      border-top: 3px solid #1e40af;
      border-radius: 50%;
      width: 20px;
      height: 20px;
      animation: spin 1s linear infinite;
      margin: auto;
    }
    
    @keyframes spin {
      0% { transform: rotate(0deg);}
      100% { transform: rotate(360deg);}
    }
    
    /* Chat container improvements */
    #chat-history {
      scroll-behavior: smooth;
    }
    
    /* Message spacing */
    .message-container {
      margin-bottom: 1.5rem;
    }
  </style>
</head>
<body class="bg-gray-100 h-screen flex flex-col">

  <header class="bg-blue-900 text-white p-4 flex items-center justify-between">
    <h1 class="text-2xl font-bold">VetDesk</h1>
    <span class="text-sm font-medium">Your Friendly VA Benefits Companion</span>
  </header>

  <main class="flex-1 flex flex-col md:flex-row overflow-hidden">

    <!-- News Feed -->
    <section id="news-feed-section" class="w-full md:w-1/3 bg-white border-r border-gray-200 overflow-y-auto p-4 flex flex-col min-w-[0]">
      <h2 class="text-xl font-semibold mb-3">Veteran News Feed</h2>
      <ul id="news-feed" class="space-y-4 flex-1"></ul>
    </section>

    <!-- Chat Section -->
    <section id="chat-section" class="flex-1 flex flex-col h-full bg-gray-50">
      <div id="welcome-message" class="p-4 text-base text-gray-700 bg-white border-b border-gray-200">
        <span>ðŸ‘‹ Hi there, and welcome! I'm here to help you get the most out of your VA benefits. Just ask a question, click a quick link, or select a news story for personalized support.</span>
      </div>
      <div id="quick-actions" class="flex flex-wrap gap-2 p-4 bg-white border-b border-gray-200"></div>
      <div id="chat-history" class="flex-1 overflow-y-auto p-4" aria-live="polite"></div>
      <form id="chat-form" class="flex gap-2 p-4 bg-white border-t border-gray-200" autocomplete="off">
        <input id="chat-input" type="text" class="flex-1 border rounded-lg px-4 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent" placeholder="Ask me anything about VA benefits..." autocomplete="off" required aria-label="Chat input" />
        <button type="submit" class="bg-blue-700 text-white px-6 py-2 rounded-lg hover:bg-blue-800 transition-colors duration-200">Send</button>
      </form>
    </section>
  </main>

  <script>
    // ====== Main Quick Actions ======
    const quickActions = [
      { text: "Can you explain VA disability ratings for me?", label: "Disability Ratings" },
      { text: "How do VA appeals work and what should I expect?", label: "Appeals Process" },
      { text: "What healthcare options do I have through the VA?", label: "VA Healthcare" },
      { text: "What benefits might I be eligible for as a veteran?", label: "Benefit Eligibility" },
      { text: "How do I get started filing a VA claim online?", label: "File a Claim" }
    ];

    // ====== Example News Feed Data ======
    const newsItems = [
      {
        title: "VA Announces New Policy Updates",
        url: "#",
        date: "2025-07-16",
        summary: "The Department of Veterans Affairs has announced updates to streamline disability claim processing."
      },
      {
        title: "Expanded Healthcare Access for Veterans",
        url: "#",
        date: "2025-07-14",
        summary: "New legislation now allows more veterans to qualify for VA healthcare coverage."
      },
      {
        title: "GI Bill Application Window Extended",
        url: "#",
        date: "2025-07-10",
        summary: "Veterans have more time to apply for the GI Bill thanks to a recent policy extension."
      }
    ];

    // ====== Render News Feed ======
    function renderNewsFeed() {
      const feed = document.getElementById('news-feed');
      feed.innerHTML = "";
      newsItems.forEach((item, idx) => {
        const li = document.createElement('li');
        li.className = "p-3 bg-gray-50 border rounded-lg shadow-sm hover:shadow-md transition-shadow";
        li.innerHTML = `
          <a href="${item.url}" class="font-semibold text-blue-800 hover:underline" target="_blank" rel="noopener">${item.title}</a>
          <div class="text-xs text-gray-500 mb-1">${item.date}</div>
          <div class="mb-2 text-sm">${item.summary}</div>
          <button type="button" class="how-affect-me-btn bg-green-100 text-green-800 px-3 py-1 rounded-md hover:bg-green-200 transition-colors text-sm font-medium" data-news-idx="${idx}">
            How does this affect me?
          </button>
        `;
        feed.appendChild(li);
      });

      // Attach event listeners for "How does this affect me?" buttons
      document.querySelectorAll('.how-affect-me-btn').forEach(btn => {
        btn.addEventListener('click', function() {
          const idx = this.getAttribute('data-news-idx');
          const news = newsItems[idx];
          addUserMessageToChat(`How does this affect me? (regarding: "${news.title}")`);
        });
      });
    }

    // ====== Render Quick Actions ======
    function renderQuickActions() {
      const qa = document.getElementById('quick-actions');
      qa.innerHTML = "";
      quickActions.forEach(action => {
        const btn = document.createElement('button');
        btn.type = "button";
        btn.className = "bg-blue-100 text-blue-900 px-3 py-2 rounded-lg hover:bg-blue-200 transition-colors text-sm font-medium";
        btn.textContent = action.label;
        btn.onclick = () => {
          addUserMessageToChat(action.text);
        };
        qa.appendChild(btn);
      });
    }

    // ====== Chat State ======
    let chatMessages = [];
    let botIsLoading = false;

    // ====== Format Bot Message with Paragraphs ======
    function formatBotMessage(text) {
      // Split on double line breaks and create paragraphs
      const paragraphs = text.split('\n\n').filter(p => p.trim());
      if (paragraphs.length > 1) {
        return paragraphs.map(p => `<p>${p.trim()}</p>`).join('');
      }
      return text;
    }

    // ====== Render Chat History with ChatGPT-style Formatting ======
    async function renderChatHistory() {
      const ch = document.getElementById('chat-history');
      ch.innerHTML = "";
      
      for (let i = 0; i < chatMessages.length; i++) {
        const msg = chatMessages[i];
        const messageDiv = document.createElement('div');
        messageDiv.className = "message-container";

        if (msg.sender === "user") {
          messageDiv.className += " flex justify-end";
          messageDiv.innerHTML = `<div class="chat-bubble-user">${msg.text}</div>`;
          ch.appendChild(messageDiv);
        } else if (msg.sender === "bot") {
          messageDiv.className += " flex justify-start";
          
          if (i === chatMessages.length - 1 && msg.streaming) {
            const botBubble = document.createElement('div');
            botBubble.className = "chat-bubble-bot";
            messageDiv.appendChild(botBubble);
            ch.appendChild(messageDiv);
            
            await streamBotText(msg.text, botBubble);
            msg.streaming = false;
          } else {
            const formattedText = formatBotMessage(msg.text);
            messageDiv.innerHTML = `<div class="chat-bubble-bot">${formattedText}</div>`;
            ch.appendChild(messageDiv);
          }
        }
      }
      
      // Loading spinner for pending bot reply
      if (botIsLoading) {
        const spinnerDiv = document.createElement('div');
        spinnerDiv.className = "message-container flex justify-center";
        spinnerDiv.innerHTML = `<div class="chat-bubble-bot flex items-center justify-center py-4"><div class="spinner" role="status" aria-label="Loading"></div></div>`;
        ch.appendChild(spinnerDiv);
      }
      
      ch.scrollTop = ch.scrollHeight;
    }

    // ====== Streaming Effect with Paragraph Support ======
    function streamBotText(text, container) {
      return new Promise(resolve => {
        const formattedText = formatBotMessage(text);
        let i = 0;
        const delay = 3; // Very fast for better UX
        
        function typeChar() {
          if (formattedText.includes('<p>')) {
            // If formatted with paragraphs, show instantly to preserve formatting
            container.innerHTML = formattedText;
            resolve();
          } else {
            // Regular streaming for simple text
            container.textContent = text.slice(0, i + 1);
            i++;
            if (i < text.length) {
              setTimeout(typeChar, delay);
            } else {
              resolve();
            }
          }
        }
        typeChar();
      });
    }

    // ====== API Integration ======
    async function getBotReply() {
      try {
        const history = chatMessages.map(m => ({
          role: m.sender === "user" ? "user" : "model",
          parts: [{ text: m.text }]
        }));
        
        const response = await fetch('https://vetdesk-demo2-api.vercel.app/api/chat', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ chatHistory: history })
        });
        
        if (!response.ok) throw new Error('API error');
        const data = await response.json();
        
        return (
          data?.candidates?.[0]?.content?.parts?.[0]?.text ||
          "Sorry, I couldn't get an answer right now."
        );
      } catch (e) {
        return "Sorry, I'm having trouble connecting. Please try again later.";
      }
    }

    // ====== Chat Functions ======
    function addUserMessageToChat(text) {
      chatMessages.push({ sender: "user", text });
      renderChatHistory();
      addBotReplyToChat();
    }

    async function addBotReplyToChat() {
      botIsLoading = true;
      await renderChatHistory();
      
      const botReply = await getBotReply();
      botIsLoading = false;
      
      chatMessages.push({ sender: "bot", text: botReply, streaming: true });
      await renderChatHistory();
    }

    // ====== Form Handler ======
    document.getElementById('chat-form').addEventListener('submit', async (e) => {
      e.preventDefault();
      const input = document.getElementById('chat-input');
      const text = input.value.trim();
      if (!text) return;
      
      addUserMessageToChat(text);
      input.value = "";
    });

    // ====== Initialize UI ======
    renderNewsFeed();
    renderQuickActions();
    renderChatHistory();

  </script>
</body>
</html>
