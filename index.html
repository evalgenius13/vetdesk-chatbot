<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>VetDeskâ„¢</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="icon" type="image/png" href="/favicon.png">
  <style>
    html, body, #root {
      height: 100%;
      margin: 0;
      background: #f9fafb;
      font-family: 'Segoe UI', sans-serif;
    }
    .message-bubble { max-width: 75%; margin: 8px 0; position: relative; word-wrap: break-word; }
    .message-bubble.user { margin-left: auto; margin-right: 8px; }
    .message-bubble.bot { margin-left: 8px; margin-right: auto; }
    .message-content { padding: 12px 16px; border-radius: 18px; box-shadow: 0 1px 3px rgba(0,0,0,0.07); position: relative; }
    .message-content.user { background: linear-gradient(135deg, #1e3a8a 0%, #1e40af 100%); color: white; border-bottom-right-radius: 6px; }
    .message-content.bot { background: white; color: #374151; border: 1px solid #e5e7eb; border-bottom-left-radius: 6px; }
    .avatar { width: 28px; height: 28px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 14px; font-weight: 600; flex-shrink: 0; margin: 0 8px; }
    .avatar.user { background: linear-gradient(135deg, #10b981 0%, #059669 100%); color: white; }
    .avatar.bot { background: white; }
    .avatar.bot img { width: 100%; height: 100%; object-fit: cover; border-radius: 50%; }
    .message-row { display: flex; align-items: flex-end; margin: 12px 0; }
    .message-row.user { justify-content: flex-end; }
    .message-row.bot { justify-content: flex-start; }
    .typing-indicator { display: flex; align-items: center; padding: 16px; margin: 12px 8px; }
    .typing-dots { display: flex; gap: 4px; margin-left: 8px; }
    .typing-dot { width: 8px; height: 8px; border-radius: 50%; background-color: #9ca3af; animation: typing 1.4s infinite ease-in-out; }
    .typing-dot:nth-child(1) { animation-delay: -0.32s; }
    .typing-dot:nth-child(2) { animation-delay: -0.16s; }
    .typing-dot:nth-child(3) { animation-delay: 0s; }
    @keyframes typing { 0%,80%,100% { transform: scale(0.8); opacity: 0.5; } 40% { transform: scale(1); opacity: 1; } }
    @media (max-width: 768px) {
      .message-bubble { max-width: 90%; }
      .news-panel { position: fixed; top: 0; left: 0; height: 100vh; width: 300px; z-index: 1000; transform: translateX(-100%); transition: transform 0.3s ease; box-shadow: 2px 0 5px rgba(0,0,0,0.1);}
      .news-panel.open { transform: translateX(0);}
      .news-overlay { position: fixed; top: 0; left: 0; width: 100vw; height: 100vh; background: rgba(0,0,0,0.3); z-index: 999; opacity: 0; visibility: hidden; transition: opacity 0.3s ease, visibility 0.3s ease;}
      .news-overlay.open { opacity: 1; visibility: visible;}
      .mobile-news-toggle { position: fixed; top: 20px; left: 20px; z-index: 1001; background: white; border: 1px solid #e5e7eb; border-radius: 50%; width: 44px; height: 44px; display: flex; align-items: center; justify-content: center; box-shadow: 0 2px 8px rgba(0,0,0,0.1);}
      .quick-actions { flex-direction: column; gap: 8px;}
      .quick-actions button { width: 100%; }
    }
    @media (min-width: 769px) {
      .mobile-news-toggle { display: none; }
      .news-overlay { display: none; }
    }
    .text-normal { font-size: 1rem; }
    .text-large { font-size: 1.125rem; }
    .text-large .message-content { font-size: 1.125rem; }
    .text-large .quick-actions button { font-size: 1rem; }
  </style>
</head>
<body>
  <div id="root"></div>
  <script type="text/babel">
function renderMarkdown(text) {
  const escaped = text.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;').replace(/"/g, '&quot;').replace(/'/g, '&#x27;');
  const sanitizeUrl = url => { const trimmed = url.trim(); if (trimmed.startsWith('http://') || trimmed.startsWith('https://')) return trimmed; return '#'; };
  return escaped.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>').replace(/\*(.*?)\*/g, '<em>$1</em>')
    .replace(/`(.*?)`/g, '<code>$1</code>') .replace(/### (.*$)/gm, '<h3>$1</h3>')
    .replace(/## (.*$)/gm, '<h2>$1</h2>') .replace(/# (.*$)/gm, '<h1>$1</h1>')
    .replace(/\n\n/g, '</p><p>').replace(/\n/g, '<br>')
    .replace(/^/, '<p>').replace(/$/, '</p>').replace(/<p><\/p>/g, '');
}
const branchAvatars = {
  "Army": "/army.png",
  "Navy": "/navy.png",
  "Air Force": "/airforce.png",
  "Marines": "/marines.png",
  "Coast Guard": "/coastguard.png",
  "Space Force": "/spaceforce.png",
  "National Guard": "/nationalguard.png"
};
function NewsPanel({ articles, loading, error, newsVisible, setNewsVisible, onAsk, isMobileOpen, onMobileClose }) {
  return (
    <aside className={`news-panel w-full md:w-[400px] border-r border-slate-200 bg-white h-full overflow-y-auto p-4 ${isMobileOpen ? 'open' : ''}`}>
      <div className="flex justify-between items-center mb-4">
        <h2 className="text-xl font-bold text-slate-800">Veterans News</h2>
        <div className="flex gap-2 items-center">
          <button
            onClick={() => setNewsVisible(v => !v)}
            className="text-sm text-blue-600 hover:text-blue-800 transition"
            title={newsVisible ? "Hide News Feed" : "Show News Feed"}
            aria-label={newsVisible ? "Hide News Feed" : "Show News Feed"}
          >
            {newsVisible ? 'âœ– Hide' : 'ðŸ“‹ Show News'}
          </button>
          {isMobileOpen && (
            <button
              onClick={onMobileClose}
              className="text-slate-500 hover:text-slate-700 md:hidden"
              aria-label="Close news panel"
            >
              <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
                <line x1="18" y1="6" x2="6" y2="18"></line>
                <line x1="6" y1="6" x2="18" y2="18"></line>
              </svg>
            </button>
          )}
        </div>
      </div>
      {newsVisible ? (
        error ? (
          <div className="text-red-600 text-sm bg-red-50 p-3 rounded">
            {error}
          </div>
        ) : loading ? (
          <div className="space-y-6">
            {[...Array(3)].map((_, idx) => (
              <div key={idx} className="animate-pulse">
                <div className="h-36 bg-gray-300 rounded mb-2"></div>
                <div className="h-4 bg-gray-300 rounded mb-1"></div>
                <div className="h-3 bg-gray-300 rounded w-3/4"></div>
              </div>
            ))}
          </div>
        ) : articles.length ? (
          articles.map((article, idx) => (
            <div key={idx} className="mb-6 pb-4 border-b last:border-none">
              {article.image && (
                <img
                  src={article.image}
                  alt={article.title}
                  loading="lazy"
                  className="mb-2 w-full h-36 object-cover rounded"
                  onError={e => { e.target.style.display = 'none'; e.target.removeAttribute('src'); e.target.alt = ''; }}
                />
              )}
              <h3 className="text-base font-semibold text-slate-900 mb-1">{article.title}</h3>
              <p className="text-xs text-slate-500">{new Date(article.pubDate).toLocaleDateString()} â€¢ {article.source}</p>
              <button
                onClick={() => { onAsk(`How does this news affect my benefits: "${article.title}"`); onMobileClose(); }}
                className="mt-3 w-full bg-blue-600 hover:bg-blue-700 text-white text-sm font-semibold py-2 rounded-md transition"
              >How does this affect me?
              </button>
            </div>
          ))
        ) : (
          <div className="text-slate-400 text-sm text-center py-8">
            <p>No news articles available.</p>
          </div>
        )
      ) : (
        <div className="text-center text-gray-400 pt-8">News feed hidden. Click "ðŸ“‹ Show News" to display.</div>
      )}
    </aside>
  );
}
function ChatbotPanel({
  messages,
  input,
  setInput,
  onSend,
  streaming,
  isLoading,
  emailState,
  onQuickAsk,
  textSize,
  setTextSize,
  onClearChat
}) {
  const textareaRef = React.useRef(null);
  const messagesEndRef = React.useRef(null);
  const [showQuickActions, setShowQuickActions] = React.useState(true);
  const [loadingAction, setLoadingAction] = React.useState(null);
  const [lastSent, setLastSent] = React.useState(0);
  const [selectedBranch, setSelectedBranch] = React.useState(sessionStorage.getItem('vetBranch') || '');

  const quickActions = [
    { text: "How does the VA calculate disability ratings, and what counts as service-connected? How does the combined rating formula work?", label: "Disability Ratings" },
    { text: "What are my options for appealing a VA decision? What are the different appeal lanes and their deadlines?", label: "Appeals Process" },
    { text: "How do VA healthcare priority groups work, and how do I access care? When can I use non-VA providers?", label: "Healthcare" },
    { text: "What are the eligibility requirements for VA benefits, and how do I know which programs or family benefits I qualify for?", label: "Eligibility" },
    { text: "Which forms do I need to file for my situation, and how do I use VA.gov or My HealtheVet to track my claim or upload documents?", label: "Forms / Tools" }
  ];
  const chatStarted = messages.length > 0 || input.trim() !== '' || isLoading || streaming;
  const charCount = input.length;
  const maxChars = 500;
  React.useEffect(() => {
    if (messagesEndRef.current) messagesEndRef.current.scrollIntoView({ behavior: 'smooth' });
  }, [messages, streaming]);
  React.useEffect(() => {
    if (!isLoading && !streaming) setLoadingAction(null);
  }, [isLoading, streaming]);
  function handleBranchChange(e) {
    const branch = e.target.value;
    setSelectedBranch(branch);
    sessionStorage.setItem('vetBranch', branch);
  }
  function handleSend() {
    const now = Date.now();
    if (now - lastSent < 1000) return;
    const trimmed = input.trim();
    if (!trimmed) return;
    setLastSent(now);
    const isValidUrl = /^https?:\/\/[^\s$.?#].[^\s]*$/.test(trimmed);
    if (isValidUrl) { onQuickAsk(`How does this article affect veterans: ${trimmed}`); }
    else { onSend(); }
    setInput('');
  }
  const handleQuickAsk = (action, idx) => {
    setLoadingAction(idx);
    onQuickAsk(action.text);
  };
  return (
    <main className={`flex flex-col flex-1 h-full ${textSize === 'large' ? 'text-large' : 'text-normal'}`}>
      <div className="border-b border-slate-200 bg-white px-4 py-2">
        <div className="flex justify-between items-center">
          <div className="flex gap-2">
            <button
              onClick={() => setTextSize('normal')}
              className={`text-xs px-2 py-1 rounded transition ${textSize === 'normal' ? 'bg-blue-800 text-white' : 'bg-gray-100 text-gray-600 hover:bg-gray-200'}`}
            >Normal Text</button>
            <button
              onClick={() => setTextSize('large')}
              className={`text-xs px-2 py-1 rounded transition ${textSize === 'large' ? 'bg-blue-800 text-white' : 'bg-gray-100 text-gray-600 hover:bg-gray-200'}`}
            >Large Text</button>
          </div>
          {messages.length > 0 && (
            <button
              onClick={onClearChat}
              className="text-xs px-3 py-1 bg-red-100 text-red-700 hover:bg-red-200 rounded transition"
            >Clear Chat</button>
          )}
        </div>
      </div>
      <div className="border-b border-slate-200 bg-white px-4 pt-3 pb-2 flex items-center justify-between gap-3 relative">
        {/* LEFT: Quick Actions */}
        <div className="flex flex-wrap items-center gap-2 flex-1 min-w-0">
          {showQuickActions && quickActions.map((action, idx) => (
            <button
              key={idx}
              onClick={() => handleQuickAsk(action, idx)}
              disabled={isLoading || streaming || loadingAction === idx}
              className={`px-3 py-2 rounded-md text-sm font-medium transition ${
                loadingAction === idx ? 'bg-blue-200 text-blue-500' : 'bg-blue-100 text-blue-700 hover:bg-blue-200'
              }`}
            >{loadingAction === idx ? 'Loading...' : action.label}
            </button>
          ))}
        </div>
        {/* RIGHT: Branch + Chevron */}
        <div className="flex items-center gap-2 ml-4">
          {showQuickActions && (
            <>
              <label htmlFor="branch-select" className="text-sm font-semibold text-slate-600">Branch:</label>
              <select
                id="branch-select"
                value={selectedBranch}
                onChange={handleBranchChange}
                className="text-sm px-2 py-1 border border-gray-300 rounded-md"
              >
                <option value="">Select Branch</option>
                {Object.keys(branchAvatars).map((branch) => (
                  <option key={branch} value={branch}>{branch}</option>
                ))}
              </select>
              {selectedBranch && branchAvatars[selectedBranch] && (
                <img
                  src={branchAvatars[selectedBranch]}
                  alt={selectedBranch}
                  className="w-7 h-7 rounded-full border"
                  title={selectedBranch}
                  style={{ objectFit: 'cover' }}
                />
              )}
            </>
          )}
          <button
            onClick={() => setShowQuickActions(!showQuickActions)}
            className="p-1 text-blue-800 hover:text-blue-900 transition"
            title={showQuickActions ? "Hide Quick Actions" : "Show Quick Actions"}
            aria-label={showQuickActions ? "Hide Quick Actions" : "Show Quick Actions"}
          >
            {showQuickActions ? (
              <svg width="20" height="20" fill="none" viewBox="0 0 20 20" aria-hidden="true">
                <path d="M6 12l4-4 4 4" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"/>
              </svg>
            ) : (
              <svg width="20" height="20" fill="none" viewBox="0 0 20 20" aria-hidden="true">
                <path d="M6 8l4 4 4-4" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"/>
              </svg>
            )}
          </button>
        </div>
      </div>
      {messages.length > 0 && (
        <div className="bg-yellow-50 border-l-4 border-yellow-400 p-3 text-sm">
          <p className="text-yellow-800">
            ðŸ’¡ <strong>Tip:</strong> This conversation isn't saved. Keep this tab open or use the email feature.
          </p>
        </div>
      )}
      {!chatStarted && !emailState?.waitingForEmail && (
        <div className="flex flex-1 items-center justify-center">
          <div className="text-center px-6 max-w-2xl">
            <h2 className="text-2xl font-bold text-gray-800 mb-3">Welcome to VetDesk</h2>
            <p className="text-lg text-gray-600 mb-2">Get plain-English answers about your VA benefits and how things are changing.</p>
            <p className="text-sm text-gray-500 italic">This conversation isn't saved. Leave this tab open while using it.</p>
          </div>
        </div>
      )}
      <div className="flex-1 px-4 py-2 overflow-y-auto space-y-2">
        {messages.map((msg, idx) => (
          <div key={idx} className={`message-row ${msg.sender}`}>
            {msg.sender === "bot" && (
              <div className="avatar bot">
                <img src="/favicon.png" alt="VetDesk Bot" className="w-8 h-8 rounded-full object-cover" style={{ background: "white" }} />
              </div>
            )}
            {msg.sender === "user" && (
              <div className="avatar user">
                {selectedBranch && branchAvatars[selectedBranch] ? (
                  <img
                    src={branchAvatars[selectedBranch]}
                    alt={selectedBranch}
                    className="w-8 h-8 rounded-full object-cover"
                  />
                ) : (
                  'U'
                )}
              </div>
            )}
            <div className={`message-bubble ${msg.sender}`}>
              <div className={`message-content ${msg.sender}`}>
                <div dangerouslySetInnerHTML={{ __html: renderMarkdown(msg.text) }} />
              </div>
            </div>
          </div>
        ))}
        {(isLoading || streaming) && (
          <div className="message-row bot typing-indicator-row">
            <div className="avatar bot"><img src="/favicon.png" alt="VetDesk Bot" className="w-8 h-8 rounded-full object-cover" style={{ background: "white" }} /></div>
            <div className="message-bubble bot">
              <div className="message-content bot">
                <div className="typing-dots">
                  <div className="typing-dot"></div>
                  <div className="typing-dot"></div>
                  <div className="typing-dot"></div>
                </div>
              </div>
            </div>
          </div>
        )}
        <div ref={messagesEndRef} />
      </div>
      {emailState?.waitingForEmail && (
        <div className="p-4 bg-yellow-50 border-t border-yellow-300 text-yellow-800 text-sm">
          Want this answer emailed? Enter your email and press Send.
        </div>
      )}
      <div className="border-t p-4 bg-white">
        {charCount > maxChars * 0.8 && (
          <div className={`text-xs text-right mb-1 ${charCount > maxChars ? 'text-red-500' : 'text-gray-500'}`}>
            {charCount}/{maxChars} characters
          </div>
        )}
        <div className="flex gap-2">
          <textarea
            ref={textareaRef}
            value={input}
            onChange={e => setInput(e.target.value)}
            rows="2"
            maxLength={maxChars}
            className="flex-1 p-2 border border-gray-300 rounded-md resize-none focus:outline-none focus:ring-2 focus:ring-blue-500"
            placeholder={
              emailState?.waitingForEmail
                ? "Enter your email addressâ€¦"
                : "Ask about VA benefits or paste a link (e.g., https://...)"
            }
            onKeyDown={e => {
              if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                handleSend();
              }
              if (e.key === 'Escape') setInput('');
            }}
            disabled={isLoading || streaming}
          />
          <button
            onClick={handleSend}
            disabled={!input.trim() || isLoading || streaming || charCount > maxChars}
            className="bg-blue-800 hover:bg-blue-900 disabled:bg-gray-400 text-white px-4 py-2 rounded-md font-semibold transition"
          >Send</button>
          <button
            onClick={() => onQuickAsk("Please email me the last response")}
            disabled={
              messages.length === 0 ||
              messages[messages.length - 1].sender !== 'bot' ||
              isLoading ||
              streaming
            }
            className="bg-blue-700 hover:bg-blue-800 disabled:bg-gray-300 text-white px-3 py-2 rounded-md text-sm"
          >Email Summary</button>
        </div>
      </div>
    </main>
  );
}
function App() {
  const [started, setStarted] = React.useState(false);
  const [messages, setMessages] = React.useState([]);
  const [input, setInput] = React.useState("");
  const [isLoading, setIsLoading] = React.useState(false);
  const [streaming, setStreaming] = React.useState(false);
  const [textSize, setTextSize] = React.useState('normal');
  const [isMobileNewsOpen, setIsMobileNewsOpen] = React.useState(false);
  const [newsVisible, setNewsVisible] = React.useState(true);
  const streamingIntervalRef = React.useRef(null);
  const [emailState, setEmailState] = React.useState({
    waitingForEmail: false, lastBotResponse: null, lastUserQuestion: null
  });
  const [articles, setArticles] = React.useState([]);
  const [loadingNews, setLoadingNews] = React.useState(true);
  const [newsError, setNewsError] = React.useState(null);

  // Example placeholder async news fetch (replace with your own logic or API)
  React.useEffect(() => {
    setLoadingNews(true);
    setTimeout(() => {
      setArticles([
        { title: 'VA aims to streamline health benefits', image: '', pubDate: new Date(), source: 'VA.gov' },
        { title: 'New PTSD tools for rural veterans', image: '', pubDate: new Date(), source: 'Stars & Stripes' }
      ]);
      setLoadingNews(false);
      setNewsError(null);
    }, 800);
  }, []);

  function onQuickAsk(text) {
    setMessages(prev => [...prev, { text, sender: "user" }]);
    // Replace with actual bot logic
    setTimeout(() => setMessages(prev => [...prev, { text: "This is a sample chatbot answer.", sender: "bot" }]), 800);
  }
  function onSend() {
    if (!input.trim() || isLoading || streaming) return;
    setMessages(prev => [...prev, { text: input, sender: "user" }]);
    setInput('');
    setTimeout(() => setMessages(prev => [...prev, { text: "Bot is responding (sample).", sender: "bot" }]), 800);
  }
  function onClearChat() {
    if (window.confirm("Are you sure you want to clear this conversation? This cannot be undone.")) {
      setMessages([]);
      setInput("");
    }
  }
  return started ? (
    <div className="flex h-screen">
      <button onClick={() => setIsMobileNewsOpen(true)} className="mobile-news-toggle" aria-label="Open news panel">ðŸ“°</button>
      <div className={`news-overlay ${isMobileNewsOpen ? 'open' : ''}`} onClick={() => setIsMobileNewsOpen(false)}></div>
      <NewsPanel
        articles={articles}
        loading={loadingNews}
        error={newsError}
        newsVisible={newsVisible}
        setNewsVisible={setNewsVisible}
        onAsk={onQuickAsk}
        isMobileOpen={isMobileNewsOpen}
        onMobileClose={() => setIsMobileNewsOpen(false)}
      />
      <ChatbotPanel
        messages={messages}
        onSend={onSend}
        input={input}
        setInput={setInput}
        streaming={streaming}
        isLoading={isLoading}
        emailState={emailState}
        onQuickAsk={onQuickAsk}
        textSize={textSize}
        setTextSize={setTextSize}
        onClearChat={onClearChat}
      />
    </div>
  ) : (
    <section className="flex flex-col justify-center h-screen px-6 bg-gradient-to-br from-slate-100 to-slate-200">
      <div className="max-w-4xl mx-auto">
        <div className="text-sm font-bold text-slate-600 uppercase mb-6">VETDESKâ„¢</div>
        <h1 className="text-5xl font-extrabold text-slate-900 mb-6">Get the Facts Fast.</h1>
        <p className="text-lg text-slate-700 mb-4">VetDesk breaks down veteran benefits and the policies that affect them - giving you immediate answers that make sense.</p>
        <p className="text-lg text-slate-700 mb-8">It's not just information. It's clarity and control. Built for veterans who need answers â€” not more questions.</p>
        <button onClick={() => setStarted(true)}
        className="bg-blue-800 hover:bg-blue-900 text-white font-semibold px-6 py-3 rounded-md shadow-md transition">
          Try Now
        </button>
      </div>
    </section>
  );
}
ReactDOM.createRoot(document.getElementById("root")).render(<React.StrictMode><App /></React.StrictMode>);
</script>
</body>
</html>
