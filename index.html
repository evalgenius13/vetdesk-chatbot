<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>VetDesk Chat</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta http-equiv="Content-Security-Policy" content="default-src 'self'; script-src 'self' 'unsafe-inline' https://cdn.tailwindcss.com; style-src 'self' 'unsafe-inline' https://cdn.tailwindcss.com; connect-src 'self' https://vetdesk-demo2-api.vercel.app; font-src 'self' data:; object-src 'none'; base-uri 'self'; form-action 'self';">
  <meta http-equiv="X-Content-Type-Options" content="nosniff">
  <meta http-equiv="Referrer-Policy" content="strict-origin-when-cross-origin">
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    @media (max-width: 768px) {
      #news-feed-section {
        display: none;
      }
      #chat-section {
        flex: 1 1 100%;
      }
    }
    .chat-bubble-user {
      max-width: 42rem;
      background: #1e40af;
      color: white;
      border-radius: 1rem;
      padding: 1rem 1.25rem;
      line-height: 1.6;
      white-space: pre-line;
      margin-left: auto;
      word-break: break-word;
    }
    .chat-bubble-bot {
      max-width: 42rem;
      background: #f9fafb;
      color: #1f2937;
      border-radius: 1rem;
      box-shadow: 0 1px 3px rgba(0,0,0,0.1);
      padding: 1.5rem;
      line-height: 1.6;
      white-space: pre-line;
      word-break: break-word;
      border: 1px solid #e5e7eb;
    }
    .chat-bubble-bot p {
      margin-bottom: 1rem;
    }
    .chat-bubble-bot p:last-child {
      margin-bottom: 0;
    }
    .spinner {
      border: 3px solid #e5e7eb;
      border-top: 3px solid #1e40af;
      border-radius: 50%;
      width: 20px;
      height: 20px;
      animation: spin 1s linear infinite;
      margin: auto;
    }
    @keyframes spin {
      0% { transform: rotate(0deg);}
      100% { transform: rotate(360deg);}
    }
    #chat-history {
      scroll-behavior: smooth;
    }
    .message-container {
      margin-bottom: 1.5rem;
    }
    .error-message {
      background: #fef2f2;
      border: 1px solid #fecaca;
      color: #dc2626;
      padding: 1rem;
      border-radius: 0.5rem;
      margin: 1rem 0;
    }
    .news-loading {
      background: #f9fafb;
      border: 1px solid #e5e7eb;
      border-radius: 0.5rem;
      padding: 1rem;
      text-align: center;
      color: #6b7280;
    }
    .news-error {
      background: #fef2f2;
      border: 1px solid #fecaca;
      color: #dc2626;
      padding: 1rem;
      border-radius: 0.5rem;
      text-align: center;
    }
    .news-item {
      transition: all 0.2s ease;
    }
    .news-item:hover {
      transform: translateY(-1px);
      box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    }
    .tooltip {
      position: relative;
      display: inline-block;
    }
    .tooltip .tooltiptext {
      visibility: hidden;
      width: 280px;
      background-color: #1e40af;
      color: white;
      text-align: center;
      border-radius: 6px;
      padding: 8px 12px;
      position: absolute;
      z-index: 1000;
      bottom: 125%;
      left: 50%;
      margin-left: -140px;
      opacity: 0;
      transition: opacity 0.3s;
      font-size: 13px;
      line-height: 1.4;
      box-shadow: 0 4px 8px rgba(0,0,0,0.1);
    }
    .tooltip .tooltiptext::after {
      content: "";
      position: absolute;
      top: 100%;
      left: 50%;
      margin-left: -5px;
      border-width: 5px;
      border-style: solid;
      border-color: #1e40af transparent transparent transparent;
    }
    .tooltip:hover .tooltiptext {
      visibility: visible;
      opacity: 1;
    }
  </style>
</head>
<body class="bg-gray-100 h-screen flex flex-col">

  <header class="bg-blue-900 text-white p-4 flex items-center">
    <h1 class="text-2xl font-bold mr-2 mb-0 inline-block">VetDeskâ„¢</h1>
    <span class="text-xs font-light text-blue-200 align-baseline">VA Benefits, Simplified.</span>
  </header>

  <main class="flex-1 flex flex-col md:flex-row overflow-hidden">

    <!-- News Feed -->
    <section id="news-feed-section" class="w-full md:w-80 bg-white border-r border-gray-200 overflow-y-auto p-4 flex flex-col min-w-[0]">
      <h2 class="text-xl font-semibold mb-3">Veteran News Feed</h2>
      <ul id="news-feed" class="space-y-4 flex-1"></ul>
    </section>

    <!-- Chat Section -->
    <section id="chat-section" class="flex-1 flex flex-col h-full bg-gray-50">
      <div class="flex items-center justify-between p-4 bg-white border-b border-gray-200">
        <div id="welcome-message" class="text-base text-gray-700">
          <span>
            ðŸ‘‹ Hi there, and welcome! I'm here to help you understand your VA benefits in plain everyday English. Just ask me any questions you have.
          </span>
        </div>
        
        <!-- Privacy tooltip -->
        <div class="tooltip">
          <svg class="w-4 h-4 text-gray-400 cursor-help" fill="currentColor" viewBox="0 0 20 20">
            <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z" clip-rule="evenodd"></path>
          </svg>
          <span class="tooltiptext">
            We do not save your information. When you refresh this page all data will be lost.
          </span>
        </div>
      </div>
      
      <div id="quick-actions" class="flex flex-wrap gap-2 p-4 bg-white border-b border-gray-200"></div>
      <div id="chat-history" class="flex-1 overflow-y-auto p-4" aria-live="polite"></div>
      <form id="chat-form" class="flex gap-2 p-4 bg-white border-t border-gray-200" autocomplete="off">
        <input id="chat-input" type="text" class="flex-1 border rounded-lg px-4 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent" placeholder="Ask me anything about VA benefits..." autocomplete="off" required aria-label="Chat input" maxlength="2000" />
        <button type="submit" id="send-button" class="bg-blue-700 text-white px-6 py-2 rounded-lg hover:bg-blue-800 transition-colors duration-200 disabled:opacity-50 disabled:cursor-not-allowed">Send</button>
      </form>
    </section>
  </main>

  <script>
    // Configuration
    const CONFIG = {
      API_URL: 'https://vetdesk-demo2-api.vercel.app/api/chat',
      NEWS_API_URL: 'https://vetdesk-demo2-api.vercel.app/api/news',
      FRONTEND_SECRET: 'vetdesk_secure_2025_kx9mR7pL3wQ8nF2vB6jC',
      MAX_MESSAGE_LENGTH: 2000,
      MAX_CONVERSATION_LENGTH: 50
    };

    // Quick actions with rates
    const quickActions = [
      { text: "Tell me about VA disability benefits", label: "Disability" },
      { text: "What VA healthcare benefits are available?", label: "Healthcare" },
      { text: "Can you explain VA education benefits?", label: "Education" },
      { text: "What are VA housing benefits?", label: "Housing" },
      { text: "What are the current VA disability compensation rates?", label: "Rates" },
      { text: "What new VA benefits or updates should I know about?", label: "What's New" }
    ];

    // Instant rate responses - all 2025 rates
    const INSTANT_RATE_RESPONSES = {
      "10": "For 10% disability, you receive $175.51 per month. Veterans with 10% or 20% ratings don't receive additional compensation for dependents.",
      "20": "For 20% disability, you receive $346.95 per month. Veterans with 10% or 20% ratings don't receive additional compensation for dependents.",
      "30": "For 30% disability:\nâ€¢ Veteran alone: $537.42/month\nâ€¢ With spouse: $601.42/month\nâ€¢ With one child: $579.42/month\nâ€¢ With spouse and one child: $648.42/month",
      "40": "For 40% disability:\nâ€¢ Veteran alone: $774.16/month\nâ€¢ With spouse: $859.16/month\nâ€¢ With one child: $831.16/month\nâ€¢ With spouse and one child: $922.16/month",
      "50": "For 50% disability:\nâ€¢ Veteran alone: $1,102.04/month\nâ€¢ With spouse: $1,208.04/month\nâ€¢ With one child: $1,173.04/month\nâ€¢ With spouse and one child: $1,287.04/month",
      "60": "For 60% disability:\nâ€¢ Veteran alone: $1,395.93/month\nâ€¢ With spouse: $1,523.93/month\nâ€¢ With one child: $1,480.93/month\nâ€¢ With spouse and one child: $1,617.93/month",
      "70": "For 70% disability:\nâ€¢ Veteran alone: $1,759.19/month\nâ€¢ With spouse: $1,908.19/month\nâ€¢ With one child: $1,858.19/month\nâ€¢ With spouse and one child: $2,018.19/month",
      "80": "For 80% disability:\nâ€¢ Veteran alone: $2,044.89/month\nâ€¢ With spouse: $2,214.89/month\nâ€¢ With one child: $2,158.89/month\nâ€¢ With spouse and one child: $2,340.89/month",
      "90": "For 90% disability:\nâ€¢ Veteran alone: $2,297.96/month\nâ€¢ With spouse: $2,489.96/month\nâ€¢ With one child: $2,425.96/month\nâ€¢ With spouse and one child: $2,630.96/month",
      "100": "For 100% disability:\nâ€¢ Veteran alone: $3,831.30/month\nâ€¢ With spouse: $4,044.91/month\nâ€¢ With one child: $3,974.15/month\nâ€¢ With spouse and one child: $4,201.35/month",
      "general": "2025 VA Disability Compensation Rates (effective December 1, 2024):\n\n10%: $175.51/month\n20%: $346.95/month\n30%: $537.42/month\n40%: $774.16/month\n50%: $1,102.04/month\n60%: $1,395.93/month\n70%: $1,759.19/month\n80%: $2,044.89/month\n90%: $2,297.96/month\n100%: $3,831.30/month\n\n(Rates shown are for veterans with no dependents. Ask about a specific percentage for dependent rates!)"
    };

    // Detect if user is asking about disability rates
    function detectRateQuestion(message) {
      const msg = message.toLowerCase();
      
      // Must contain rate-related keywords
      const rateKeywords = ['how much', 'rate', 'payment', 'compensation', 'amount', 'pay', 'money', 'receive', 'get paid'];
      if (!rateKeywords.some(keyword => msg.includes(keyword))) {
        return null;
      }
      
      // Look for specific percentages
      const percentMatches = [
        msg.match(/(\d{1,3})%/),  // "70%"
        msg.match(/(\d{1,3})\s*percent/), // "70 percent"
        msg.match(/\b(\d{1,3})\b/), // "what about 70"
      ];
      
      for (const match of percentMatches) {
        if (match && match[1]) {
          const num = parseInt(match[1]);
          if (num >= 10 && num <= 100 && num % 10 === 0) {
            return num.toString();
          }
        }
      }
      
      // Word-based percentages
      const wordMatch = msg.match(/\b(ten|twenty|thirty|forty|fifty|sixty|seventy|eighty|ninety|one hundred|hundred)\b/);
      if (wordMatch) {
        const wordToNum = {
          'ten': '10', 'twenty': '20', 'thirty': '30', 'forty': '40', 'fifty': '50',
          'sixty': '60', 'seventy': '70', 'eighty': '80', 'ninety': '90', 
          'hundred': '100', 'one hundred': '100'
        };
        const percentage = wordToNum[wordMatch[1]];
        if (percentage) return percentage;
      }
      
      // General rate inquiry
      if (msg.includes('rates') || msg.includes('compensation')) {
        return 'general';
      }
      
      return null;
    }

    // ====== News Feed Management ======
    let newsItems = [];
    let newsLoading = false;

    async function fetchNews(forceRefresh = false) {
      if (newsLoading) return;

      newsLoading = true;
      const newsFeed = document.getElementById('news-feed');

      try {
        showNewsLoading();

        const response = await fetch(CONFIG.NEWS_API_URL, {
          method: 'GET',
          headers: {
            'Accept': 'application/json'
          }
        });

        if (!response.ok) {
          throw new Error(`HTTP ${response.status}`);
        }

        const data = await response.json();

        if (data.error && !data.articles?.length) {
          throw new Error(data.error);
        }

        newsItems = data.articles || [];
        renderNewsFeed();

      } catch (error) {
        console.error('News fetch error:', error);
        showNewsError(error.message);
      } finally {
        newsLoading = false;
      }
    }

    function showNewsLoading() {
      const feed = document.getElementById('news-feed');
      feed.innerHTML = '<li class="p-3 bg-gray-50 border rounded-lg text-center text-gray-500"><div class="spinner"></div><p class="mt-2">Loading news...</p></li>';
    }

    function showNewsError(message) {
      const feed = document.getElementById('news-feed');
      feed.innerHTML = `<li class="p-3 bg-red-50 border border-red-200 rounded-lg text-center text-red-600">Unable to load news</li>`;
    }

    function renderNewsFeed() {
      const feed = document.getElementById('news-feed');
      feed.innerHTML = "";

      if (!newsItems.length) {
        feed.innerHTML = '<li class="text-gray-500 text-center py-4">No news available</li>';
        return;
      }

      newsItems.forEach((item, idx) => {
        const li = document.createElement('li');
        li.className = "p-3 bg-gray-50 border rounded-lg shadow-sm hover:shadow-md transition-shadow";

        const titleText = escapeHtml(item.title);
        const summaryText = escapeHtml(item.summary);

        li.innerHTML = `
          <a href="${escapeHtml(item.url)}" class="font-semibold text-blue-800 hover:underline" target="_blank" rel="noopener noreferrer">${titleText}</a>
          ${item.date ? `<div class="text-xs text-gray-500 mb-1">${escapeHtml(item.date)}</div>` : ''}
          <div class="mb-2 text-sm">${summaryText}</div>
          <button type="button" class="how-affect-me-btn bg-green-100 text-green-800 px-3 py-1 rounded-md hover:bg-green-200 transition-colors text-sm font-medium" data-news-idx="${idx}">
            How does this affect me?
          </button>
        `;
        feed.appendChild(li);
      });

      // Attach event listeners for "How does this affect me?" buttons
      document.querySelectorAll('.how-affect-me-btn').forEach(btn => {
        btn.addEventListener('click', function() {
          const idx = parseInt(this.getAttribute('data-news-idx'));
          const news = newsItems[idx];
          if (news) {
            const userMessage = `How does "${news.title}" affect me?`;
            addUserMessageToChat(userMessage);
          }
        });
      });
    }

    // ====== Security Helper Functions ======
    function escapeHtml(text) {
      if (!text) return '';
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }

    function validateMessageLength(text) {
      return text && text.trim().length > 0 && text.length <= CONFIG.MAX_MESSAGE_LENGTH;
    }

    // ====== Render Quick Actions ======
    function renderQuickActions() {
      const qa = document.getElementById('quick-actions');
      qa.innerHTML = "";
      quickActions.forEach(action => {
        const btn = document.createElement('button');
        btn.type = "button";
        btn.className = "bg-blue-100 text-blue-900 px-3 py-2 rounded-lg hover:bg-blue-200 transition-colors text-sm font-medium";
        btn.textContent = action.label;
        btn.onclick = () => {
          // Check if it's the rates quick action
          if (action.text === "What are the current VA disability compensation rates?") {
            chatMessages.push({ sender: "user", text: action.text });
            renderChatHistory();
            addInstantBotResponse(INSTANT_RATE_RESPONSES["general"]);
          } else {
            addUserMessageToChat(action.text);
          }
        };
        qa.appendChild(btn);
      });
    }

    // ====== Chat State ======
    let chatMessages = [];
    let botIsLoading = false;
    let rateLimitWarning = false;

    // ====== Error Handling ======
    function showError(message) {
      const ch = document.getElementById('chat-history');
      const errorDiv = document.createElement('div');
      errorDiv.className = "message-container";
      errorDiv.innerHTML = `<div class="error-message">${escapeHtml(message)}</div>`;
      ch.appendChild(errorDiv);
      ch.scrollTop = ch.scrollHeight;
    }

    // ====== Format Bot Message with Paragraphs ======
    function formatBotMessage(text) {
      const sanitized = escapeHtml(text);
      const paragraphs = sanitized.split('\n\n').filter(p => p.trim());
      if (paragraphs.length > 1) {
        return paragraphs.map(p => `<p>${p.trim()}</p>`).join('');
      }
      return sanitized;
    }

    // ====== Add instant bot response ======
    function addInstantBotResponse(text) {
      chatMessages.push({ sender: "bot", text: text, streaming: false });
      renderChatHistory();
    }

    // ====== Render Chat History with ChatGPT-style Formatting ======
    async function renderChatHistory() {
      const ch = document.getElementById('chat-history');
      ch.innerHTML = "";

      for (let i = 0; i < chatMessages.length; i++) {
        const msg = chatMessages[i];
        const messageDiv = document.createElement('div');
        messageDiv.className = "message-container";

        if (msg.sender === "user") {
          messageDiv.className += " flex justify-end";
          messageDiv.innerHTML = `<div class="chat-bubble-user">${escapeHtml(msg.text)}</div>`;
          ch.appendChild(messageDiv);
        } else if (msg.sender === "bot") {
          messageDiv.className += " flex justify-start";

          if (i === chatMessages.length - 1 && msg.streaming) {
            const botBubble = document.createElement('div');
            botBubble.className = "chat-bubble-bot";
            messageDiv.appendChild(botBubble);
            ch.appendChild(messageDiv);

            await streamBotText(msg.text, botBubble);
            msg.streaming = false;
          } else {
            const formattedText = formatBotMessage(msg.text);
            messageDiv.innerHTML = `<div class="chat-bubble-bot">${formattedText}</div>`;
            ch.appendChild(messageDiv);
          }
        }
      }

      // Loading spinner for pending bot reply
      if (botIsLoading) {
        const spinnerDiv = document.createElement('div');
        spinnerDiv.className = "message-container flex justify-center";
        spinnerDiv.innerHTML = `<div class="chat-bubble-bot flex items-center justify-center py-4"><div class="spinner" role="status" aria-label="Loading"></div></div>`;
        ch.appendChild(spinnerDiv);
      }

      ch.scrollTop = ch.scrollHeight;
    }

    // ====== Streaming Effect with Paragraph Support ======
    function streamBotText(text, container) {
      return new Promise(resolve => {
        const formattedText = formatBotMessage(text);
        let i = 0;
        const delay = 3;

        function typeChar() {
          if (formattedText.includes('<p>')) {
            container.innerHTML = formattedText;
            resolve();
          } else {
            container.textContent = text.slice(0, i + 1);
            i++;
            if (i < text.length) {
              setTimeout(typeChar, delay);
            } else {
              resolve();
            }
          }
        }
        typeChar();
      });
    }

    // ====== Secure API Integration ======
    async function getBotReply() {
      try {
        if (chatMessages.length > CONFIG.MAX_CONVERSATION_LENGTH) {
          throw new Error('Conversation too long. Please start a new conversation.');
        }

        const history = chatMessages.map(m => ({
          role: m.sender === "user" ? "user" : "model",
          parts: [{ text: m.text }]
        }));

        const response = await fetch(CONFIG.API_URL, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${CONFIG.FRONTEND_SECRET}`
          },
          body: JSON.stringify({ chatHistory: history })
        });

        if (response.status === 429) {
          if (!rateLimitWarning) {
            rateLimitWarning = true;
            setTimeout(() => { rateLimitWarning = false; }, 60000);
          }
          throw new Error('Too many requests. Please wait a moment before trying again.');
        }

        if (response.status === 401) {
          throw new Error('Authentication failed. Please refresh the page.');
        }

        if (!response.ok) {
          throw new Error(`Server error (${response.status}). Please try again later.`);
        }

        const data = await response.json();

        return (
          data?.candidates?.[0]?.content?.parts?.[0]?.text ||
          "Sorry, I couldn't get an answer right now."
        );
      } catch (e) {
        console.error('API Error:', e);

        if (e.message.includes('fetch')) {
          return "Sorry, I'm having trouble connecting. Please check your internet connection and try again.";
        }

        return e.message || "Sorry, something went wrong. Please try again later.";
      }
    }

    // ====== Chat Functions with Validation ======
    function addUserMessageToChat(text) {
      const trimmedText = text.trim();

      if (!validateMessageLength(trimmedText)) {
        showError(`Message must be between 1 and ${CONFIG.MAX_MESSAGE_LENGTH} characters.`);
        return;
      }

      if (chatMessages.length >= CONFIG.MAX_CONVERSATION_LENGTH) {
        showError('Conversation limit reached. Please refresh to start a new conversation.');
        return;
      }

      if (botIsLoading) {
        showError('Please wait for the current response to finish.');
        return;
      }

      chatMessages.push({ sender: "user", text: trimmedText });
      renderChatHistory();
      addBotReplyToChat();
    }

    async function addBotReplyToChat() {
      botIsLoading = true;
      const sendButton = document.getElementById('send-button');
      const chatInput = document.getElementById('chat-input');

      sendButton.disabled = true;
      chatInput.disabled = true;

      await renderChatHistory();

      const botReply = await getBotReply();

      botIsLoading = false;
      sendButton.disabled = false;
      chatInput.disabled = false;

      chatInput.focus();

      chatMessages.push({ sender: "bot", text: botReply, streaming: true });
      await renderChatHistory();
    }

    // ====== Event Listeners ======
    document.getElementById('chat-form').addEventListener('submit', async (e) => {
      e.preventDefault();
      const input = document.getElementById('chat-input');
      const text = input.value.trim();

      if (!text) return;

      if (!validateMessageLength(text)) {
        showError(`Message must be between 1 and ${CONFIG.MAX_MESSAGE_LENGTH} characters.`);
        return;
      }

      // Check for instant rate response first
      const rateResponse = detectRateQuestion(text);
      if (rateResponse && INSTANT_RATE_RESPONSES[rateResponse]) {
        // Add user message
        chatMessages.push({ sender: "user", text: text });
        
        // Add instant rate response
        addInstantBotResponse(INSTANT_RATE_RESPONSES[rateResponse]);
        
        input.value = "";
        return; // Don't send to AI
      }

      // Otherwise, proceed with normal AI chat
      addUserMessageToChat(text);
      input.value = "";
    });

    document.getElementById('chat-input').addEventListener('input', function(e) {
      const length = e.target.value.length;
      const button = document.getElementById('send-button');

      if (length > CONFIG.MAX_MESSAGE_LENGTH) {
        e.target.value = e.target.value.substring(0, CONFIG.MAX_MESSAGE_LENGTH);
      }

      button.disabled = e.target.value.trim().length === 0 || botIsLoading;
    });

    // ====== Initialize ======
    document.addEventListener('DOMContentLoaded', () => {
      renderQuickActions();
      renderChatHistory();
      fetchNews();
      document.getElementById('chat-input').focus();
    });

    // Keyboard shortcuts
    document.addEventListener('keydown', function(e) {
      if ((e.ctrlKey || e.metaKey) && e.key === 'Enter') {
        document.getElementById('chat-form').dispatchEvent(new Event('submit'));
      }
    });

  </script>
</body>
</html>
